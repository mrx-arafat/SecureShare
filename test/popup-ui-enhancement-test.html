<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popup UI Enhancement Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .popup-preview {
            max-width: 400px;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .popup-preview iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .mock-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .status-demo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .status-logged-in { background: #d4edda; }
        .status-likely-logged-in { background: #fff3cd; }
        .status-not-logged-in { background: #f8d7da; }
        .status-unknown { background: #e2e3e5; }
    </style>
</head>
<body>
    <h1>🎨 Popup UI Enhancement Tests</h1>
    <p>Test enhanced session sharing UI with login detection and session preview</p>

    <div class="test-container">
        <h2>Login Detection Module Status</h2>
        <div id="login-detection-status">
            <p>Loading login detection module...</p>
        </div>
        <button onclick="checkLoginDetectionStatus()">🔍 Check Status</button>
        <button onclick="testLoginDetection()">🧪 Test Detection</button>
    </div>

    <div class="test-container">
        <h2>Mock Login Status Tests</h2>
        <p>Test different login scenarios and their UI representation:</p>
        <button onclick="simulateNetflixLogin()">📺 Netflix Logged In</button>
        <button onclick="simulateYouTubeLogin()">📹 YouTube Logged In</button>
        <button onclick="simulateGitHubLogin()">🐙 GitHub Logged In</button>
        <button onclick="simulateNotLoggedIn()">❌ Not Logged In</button>
        <button onclick="simulateUnknownSite()">❓ Unknown Site</button>
    </div>

    <div class="test-container">
        <h2>Login Status Display Demo</h2>
        <div id="status-demo-area">
            <p>Login status examples will appear here</p>
        </div>
        <button onclick="showAllStatusTypes()">📊 Show All Status Types</button>
        <button onclick="clearStatusDemo()">🧹 Clear Demo</button>
    </div>

    <div class="test-container">
        <h2>Session Preview Enhancement</h2>
        <div class="mock-data" id="session-preview-demo">
            <h4>Session Preview Data:</h4>
            <p>No session data loaded</p>
        </div>
        <button onclick="testSessionPreview()">📊 Test Session Preview</button>
        <button onclick="testSecurityLevels()">🔒 Test Security Levels</button>
    </div>

    <div class="test-container">
        <h2>Real-time Status Updates</h2>
        <p>Test the progression of status messages during QR generation:</p>
        <div id="status-progression" class="mock-data">
            <p>Status progression will appear here</p>
        </div>
        <button onclick="simulateQRGeneration()">🔄 Simulate QR Generation</button>
        <button onclick="simulateSessionRefresh()">🔄 Simulate Session Refresh</button>
    </div>

    <div class="test-container">
        <h2>User Information Display</h2>
        <div id="user-info-demo">
            <p>User information examples will appear here</p>
        </div>
        <button onclick="testUserInfoDisplay()">👤 Test User Info</button>
        <button onclick="testPrivacyMasking()">🔒 Test Privacy Masking</button>
    </div>

    <div class="test-container">
        <h2>Popup Preview</h2>
        <p>Live preview of the enhanced popup interface:</p>
        <div class="popup-preview">
            <iframe id="popup-iframe" src="about:blank"></iframe>
        </div>
        <button onclick="loadPopupPreview()">🎨 Load Popup Preview</button>
        <button onclick="loadPopupWithMockData()">📊 Load with Mock Data</button>
    </div>

    <div class="test-container">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">🚀 Run All Tests</button>
        <button onclick="testLoginDetectionModule()">🔍 Test Login Detection</button>
        <button onclick="testUIComponents()">🎨 Test UI Components</button>
        <button onclick="testStatusProgression()">⏱️ Test Status Updates</button>
        <button onclick="testErrorHandling()">❌ Test Error Handling</button>
        <button onclick="clearResults()">🗑️ Clear Results</button>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <!-- Load login detection module -->
    <script src="../popup/js/loginDetection.js"></script>

    <!-- Test Suite -->
    <script>
        let testResults = [];
        let testCount = 0;
        let passCount = 0;

        function addTestResult(name, passed, message, details = null) {
            testCount++;
            if (passed) passCount++;
            
            testResults.push({
                name,
                passed,
                message,
                details,
                timestamp: new Date().toLocaleTimeString()
            });
            
            updateTestDisplay();
        }

        function updateTestDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = 'test-result test-info';
            summary.textContent = `Tests: ${testCount} | Passed: ${passCount} | Failed: ${testCount - passCount}`;
            container.appendChild(summary);
            
            // Add individual results
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                
                let content = `[${result.timestamp}] ${result.passed ? '✅' : '❌'} ${result.name}: ${result.message}`;
                if (result.details) {
                    content += `\nDetails: ${JSON.stringify(result.details, null, 2)}`;
                }
                
                div.textContent = content;
                container.appendChild(div);
            });
        }

        function clearResults() {
            testResults = [];
            testCount = 0;
            passCount = 0;
            updateTestDisplay();
        }

        function checkLoginDetectionStatus() {
            const statusEl = document.getElementById('login-detection-status');
            
            if (window.LoginDetection) {
                statusEl.innerHTML = `
                    <h4>✅ Login Detection Module Loaded</h4>
                    <p><strong>Auth Patterns:</strong> ${window.LoginDetection.AUTH_COOKIE_PATTERNS.length}</p>
                    <p><strong>Site Patterns:</strong> ${Object.keys(window.LoginDetection.SITE_SPECIFIC_PATTERNS).length}</p>
                    <p><strong>Methods Available:</strong> detectLoginStatus, formatLoginStatus</p>
                `;
                addTestResult('Login Detection Status', true, 'Module loaded successfully');
            } else {
                statusEl.innerHTML = '<h4>❌ Login Detection Module Not Loaded</h4>';
                addTestResult('Login Detection Status', false, 'Module not available');
            }
        }

        function testLoginDetection() {
            if (window.LoginDetection) {
                // Test with mock data since we can't access real Chrome APIs in test environment
                const mockCookies = [
                    { name: 'session_id', value: 'abc123', secure: true, httpOnly: true },
                    { name: 'auth_token', value: 'xyz789', secure: true, httpOnly: false },
                    { name: 'user_pref', value: 'settings', secure: false, httpOnly: false }
                ];
                
                const analysis = window.LoginDetection.analyzeCookies(mockCookies, 'example.com');
                
                addTestResult('Login Detection Analysis', analysis.isLoggedIn, 
                    `Detected login: ${analysis.isLoggedIn}, Confidence: ${analysis.confidence}%`, analysis);
            } else {
                addTestResult('Login Detection Analysis', false, 'Module not available');
            }
        }

        function simulateNetflixLogin() {
            const mockLoginInfo = {
                isLoggedIn: true,
                confidence: 95,
                indicators: ['site_specific_cookies', 'auth_cookies_found'],
                userInfo: { email: 'user@example.com' },
                sessionCookies: [
                    { name: 'NetflixId', value: 'encrypted_data' },
                    { name: 'SecureNetflixId', value: 'secure_data' }
                ],
                domain: 'netflix.com',
                title: 'Netflix - Watch TV Shows Online, Watch Movies Online',
                favicon: 'https://assets.nflxext.com/us/ffe/siteui/common/icons/nficon2016.ico'
            };
            
            displayLoginStatus(mockLoginInfo, 'Netflix');
        }

        function simulateYouTubeLogin() {
            const mockLoginInfo = {
                isLoggedIn: true,
                confidence: 88,
                indicators: ['site_specific_cookies', 'user_info_found'],
                userInfo: { username: 'YouTubeUser123' },
                sessionCookies: [
                    { name: 'SAPISID', value: 'session_data' },
                    { name: 'LOGIN_INFO', value: 'user_data' }
                ],
                domain: 'youtube.com',
                title: 'YouTube',
                favicon: 'https://www.youtube.com/favicon.ico'
            };
            
            displayLoginStatus(mockLoginInfo, 'YouTube');
        }

        function simulateGitHubLogin() {
            const mockLoginInfo = {
                isLoggedIn: true,
                confidence: 92,
                indicators: ['site_specific_cookies', 'secure_cookies'],
                userInfo: { username: 'developer123' },
                sessionCookies: [
                    { name: 'user_session', value: 'github_session' },
                    { name: 'logged_in', value: 'yes' }
                ],
                domain: 'github.com',
                title: 'GitHub',
                favicon: 'https://github.com/favicon.ico'
            };
            
            displayLoginStatus(mockLoginInfo, 'GitHub');
        }

        function simulateNotLoggedIn() {
            const mockLoginInfo = {
                isLoggedIn: false,
                confidence: 0,
                indicators: ['no_auth_cookies'],
                userInfo: null,
                sessionCookies: [],
                domain: 'example.com',
                title: 'Example Website',
                favicon: null
            };
            
            displayLoginStatus(mockLoginInfo, 'Not Logged In');
        }

        function simulateUnknownSite() {
            const mockLoginInfo = {
                isLoggedIn: false,
                confidence: 25,
                indicators: ['generic_cookies'],
                userInfo: null,
                sessionCookies: [
                    { name: 'visitor_id', value: 'visitor123' }
                ],
                domain: 'unknown-site.com',
                title: 'Unknown Website',
                favicon: null
            };
            
            displayLoginStatus(mockLoginInfo, 'Unknown Site');
        }

        function displayLoginStatus(loginInfo, scenario) {
            if (window.LoginDetection) {
                const formatted = window.LoginDetection.formatLoginStatus(loginInfo);
                
                const demoArea = document.getElementById('status-demo-area');
                const statusDiv = document.createElement('div');
                statusDiv.className = `status-demo ${formatted.statusClass}`;
                statusDiv.innerHTML = `
                    <span style="font-size: 20px;">${formatted.statusIcon}</span>
                    <div>
                        <strong>${scenario}:</strong> ${formatted.statusText} (${formatted.confidenceText})
                        <br><small>User: ${formatted.userDisplay} | Cookies: ${formatted.sessionCount}</small>
                    </div>
                `;
                
                demoArea.appendChild(statusDiv);
                
                addTestResult(`${scenario} Simulation`, true, `Status: ${formatted.statusText}`, formatted);
            } else {
                addTestResult(`${scenario} Simulation`, false, 'Login detection module not available');
            }
        }

        function showAllStatusTypes() {
            simulateNetflixLogin();
            setTimeout(() => simulateYouTubeLogin(), 100);
            setTimeout(() => simulateGitHubLogin(), 200);
            setTimeout(() => simulateNotLoggedIn(), 300);
            setTimeout(() => simulateUnknownSite(), 400);
        }

        function clearStatusDemo() {
            const demoArea = document.getElementById('status-demo-area');
            demoArea.innerHTML = '<p>Login status examples will appear here</p>';
        }

        function testSessionPreview() {
            const mockSessionData = {
                domain: 'netflix.com',
                title: 'Netflix - Home',
                sessionCookies: 5,
                securityLevel: 'High',
                confidence: 95,
                estimatedDuration: '30 minutes'
            };
            
            const demoEl = document.getElementById('session-preview-demo');
            demoEl.innerHTML = `
                <h4>Session Preview Data:</h4>
                <p><strong>🌐 Website:</strong> ${mockSessionData.title}</p>
                <p><strong>🍪 Session Cookies:</strong> ${mockSessionData.sessionCookies} cookies</p>
                <p><strong>🔒 Security Level:</strong> ${mockSessionData.securityLevel}</p>
                <p><strong>⏱️ Duration:</strong> ${mockSessionData.estimatedDuration}</p>
            `;
            
            addTestResult('Session Preview', true, 'Session preview data displayed', mockSessionData);
        }

        function testSecurityLevels() {
            const securityLevels = [
                { level: 'High', confidence: 95, icon: '🔐' },
                { level: 'Medium', confidence: 70, icon: '🔒' },
                { level: 'Low', confidence: 30, icon: '⚠️' }
            ];
            
            const demoEl = document.getElementById('session-preview-demo');
            demoEl.innerHTML = `
                <h4>Security Level Examples:</h4>
                ${securityLevels.map(s => `
                    <p><strong>${s.icon} ${s.level}:</strong> ${s.confidence}% confidence</p>
                `).join('')}
            `;
            
            addTestResult('Security Levels', true, 'Security level examples displayed', securityLevels);
        }

        function simulateQRGeneration() {
            const statusEl = document.getElementById('status-progression');
            const steps = [
                { icon: '🔍', text: 'Analyzing session...', delay: 0 },
                { icon: '📊', text: 'Capturing session data...', delay: 1000 },
                { icon: '🔐', text: 'Encrypting data...', delay: 2000 },
                { icon: '📱', text: 'Generating QR code...', delay: 3000 },
                { icon: '✅', text: 'Ready to scan!', delay: 4000 }
            ];
            
            steps.forEach(step => {
                setTimeout(() => {
                    statusEl.innerHTML = `
                        <div class="status-demo">
                            <span style="font-size: 20px;">${step.icon}</span>
                            <span>${step.text}</span>
                        </div>
                    `;
                }, step.delay);
            });
            
            addTestResult('QR Generation Simulation', true, 'Status progression simulated');
        }

        function simulateSessionRefresh() {
            const statusEl = document.getElementById('status-progression');
            statusEl.innerHTML = `
                <div class="status-demo">
                    <span style="font-size: 20px;">🔄</span>
                    <span>Refreshing session data...</span>
                </div>
            `;
            
            setTimeout(() => {
                statusEl.innerHTML = `
                    <div class="status-demo">
                        <span style="font-size: 20px;">✅</span>
                        <span>Session data updated!</span>
                    </div>
                `;
            }, 1500);
            
            addTestResult('Session Refresh Simulation', true, 'Session refresh simulated');
        }

        function testUserInfoDisplay() {
            const userExamples = [
                { type: 'Email', value: 'user@example.com', masked: 'u***@example.com' },
                { type: 'Username', value: 'john_doe_123', masked: 'john_***' },
                { type: 'Display Name', value: 'John Doe', masked: 'John D.' },
                { type: 'User ID', value: '123456789', masked: 'User ID: ***6789' }
            ];
            
            const demoEl = document.getElementById('user-info-demo');
            demoEl.innerHTML = `
                <h4>User Information Examples:</h4>
                ${userExamples.map(u => `
                    <p><strong>${u.type}:</strong> ${u.value}</p>
                `).join('')}
            `;
            
            addTestResult('User Info Display', true, 'User information examples shown', userExamples);
        }

        function testPrivacyMasking() {
            const userExamples = [
                { type: 'Email', value: 'user@example.com', masked: 'u***@example.com' },
                { type: 'Username', value: 'john_doe_123', masked: 'john_***' },
                { type: 'Display Name', value: 'John Doe', masked: 'John D.' },
                { type: 'User ID', value: '123456789', masked: 'User ID: ***6789' }
            ];
            
            const demoEl = document.getElementById('user-info-demo');
            demoEl.innerHTML = `
                <h4>Privacy Masked Examples:</h4>
                ${userExamples.map(u => `
                    <p><strong>${u.type}:</strong> ${u.masked}</p>
                `).join('')}
            `;
            
            addTestResult('Privacy Masking', true, 'Privacy masking examples shown', userExamples);
        }

        function loadPopupPreview() {
            const iframe = document.getElementById('popup-iframe');
            iframe.src = '../popup/index.html';
            addTestResult('Popup Preview', true, 'Popup loaded in preview');
        }

        function loadPopupWithMockData() {
            // This would require injecting mock data into the popup
            const iframe = document.getElementById('popup-iframe');
            iframe.src = '../popup/index.html#mock=true';
            addTestResult('Popup with Mock Data', true, 'Popup loaded with mock data');
        }

        function testLoginDetectionModule() {
            checkLoginDetectionStatus();
            testLoginDetection();
        }

        function testUIComponents() {
            showAllStatusTypes();
            testSessionPreview();
            testSecurityLevels();
        }

        function testStatusProgression() {
            simulateQRGeneration();
            setTimeout(() => simulateSessionRefresh(), 5000);
        }

        function testErrorHandling() {
            // Test error scenarios
            const errorScenarios = [
                'No cookies found',
                'Invalid session data',
                'Network connection failed',
                'Permission denied'
            ];
            
            errorScenarios.forEach((scenario, index) => {
                setTimeout(() => {
                    addTestResult(`Error Handling: ${scenario}`, true, 'Error scenario tested');
                }, index * 100);
            });
        }

        async function runAllTests() {
            clearResults();
            addTestResult('Test Suite', true, 'Starting popup UI enhancement tests...');
            
            testLoginDetectionModule();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testUIComponents();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testStatusProgression();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testUserInfoDisplay();
            testPrivacyMasking();
            testErrorHandling();
            
            loadPopupPreview();
            
            addTestResult('Test Suite', true, 'All popup UI enhancement tests completed!');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginDetectionStatus();
            updateTestDisplay();
        });
    </script>
</body>
</html>
