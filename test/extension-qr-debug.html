<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension QR Debug</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            margin: 0;
        }
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            align-items: start;
        }
        .extension-frame {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            position: sticky;
            top: 20px;
        }
        .extension-frame iframe {
            width: 100%;
            height: 600px;
            border: none;
            display: block;
        }
        .debug-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            color: #333;
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #d94343;
        }
        .btn {
            background: #d94343;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover {
            background: #c13333;
        }
        .console-output {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="extension-frame">
            <iframe src="../popup/index.html" id="extension-iframe"></iframe>
        </div>
        
        <div class="debug-panel">
            <h1>🔧 Extension QR Debug</h1>
            <p>Debug the QR code generation issues in the SecureShare extension.</p>

            <div class="debug-section">
                <h3>🎯 Issues to Debug</h3>
                <ul>
                    <li>QR code canvas appears empty</li>
                    <li>URL encoding showing %22%3E characters</li>
                    <li>QRious library integration</li>
                    <li>Canvas sizing and visibility</li>
                </ul>
            </div>

            <div class="debug-section">
                <h3>🔍 Debug Actions</h3>
                <button class="btn" onclick="checkExtensionState()">📊 Check Extension State</button>
                <button class="btn" onclick="inspectCanvas()">🎨 Inspect Canvas</button>
                <button class="btn" onclick="testQRGeneration()">🧪 Test QR Generation</button>
                <button class="btn" onclick="viewConsole()">📝 View Console</button>
                <div id="debug-status"></div>
            </div>

            <div class="debug-section">
                <h3>📋 Console Output</h3>
                <div id="console-output" class="console-output">
                    Console messages will appear here...
                </div>
                <button class="btn" onclick="clearConsole()">🗑️ Clear Console</button>
            </div>

            <div class="debug-section">
                <h3>🔧 Quick Fixes</h3>
                <button class="btn" onclick="fixCanvasSize()">📐 Fix Canvas Size</button>
                <button class="btn" onclick="forceQRGeneration()">🔄 Force QR Generation</button>
                <button class="btn" onclick="testFallback()">🆘 Test Fallback</button>
            </div>

            <div class="debug-section">
                <h3>📱 Mobile URL Test</h3>
                <button class="btn" onclick="generateTestURL()">🔗 Generate Test URL</button>
                <button class="btn" onclick="openMobileTest()" id="mobile-test-btn" style="display: none;">📲 Open Mobile Test</button>
                <div id="url-preview" style="display: none; margin-top: 10px;">
                    <strong>Generated URL:</strong>
                    <div class="console-output" id="url-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let testMobileURL = null;

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('debug-status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function logToConsole(message) {
            const consoleEl = document.getElementById('console-output');
            const timestamp = new Date().toLocaleTimeString();
            consoleEl.innerHTML += `[${timestamp}] ${message}\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function clearConsole() {
            document.getElementById('console-output').innerHTML = 'Console cleared...\n';
        }

        function checkExtensionState() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;

                logToConsole('=== Extension State Check ===');
                logToConsole('Iframe loaded: ' + (iframeDoc ? 'Yes' : 'No'));
                
                if (iframeDoc) {
                    const canvas = iframeDoc.getElementById('js-qr-canvas-share');
                    logToConsole('QR Canvas found: ' + (canvas ? 'Yes' : 'No'));
                    
                    if (canvas) {
                        logToConsole('Canvas dimensions: ' + canvas.width + 'x' + canvas.height);
                        logToConsole('Canvas style: ' + canvas.style.cssText);
                        logToConsole('Canvas display: ' + getComputedStyle(canvas).display);
                    }

                    const qrResult = iframeDoc.getElementById('js-qr-result');
                    logToConsole('QR Result container: ' + (qrResult ? 'Found' : 'Not found'));
                    if (qrResult) {
                        logToConsole('QR Result visible: ' + !qrResult.classList.contains('hidden'));
                    }

                    logToConsole('QRious library: ' + (iframeWindow.QRious ? 'Loaded' : 'Not loaded'));
                    logToConsole('qrShareDirect module: ' + (iframeWindow.qrShareDirect ? 'Loaded' : 'Not loaded'));
                }

                showStatus('✅ Extension state checked - see console output', 'success');
            } catch (error) {
                logToConsole('Error checking extension state: ' + error.message);
                showStatus('❌ Failed to check extension state', 'error');
            }
        }

        function inspectCanvas() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeDoc = iframe.contentDocument;
                const canvas = iframeDoc.getElementById('js-qr-canvas-share');

                if (canvas) {
                    logToConsole('=== Canvas Inspection ===');
                    logToConsole('Canvas element: ' + canvas.tagName);
                    logToConsole('Canvas ID: ' + canvas.id);
                    logToConsole('Canvas width: ' + canvas.width);
                    logToConsole('Canvas height: ' + canvas.height);
                    logToConsole('Canvas clientWidth: ' + canvas.clientWidth);
                    logToConsole('Canvas clientHeight: ' + canvas.clientHeight);
                    logToConsole('Canvas offsetWidth: ' + canvas.offsetWidth);
                    logToConsole('Canvas offsetHeight: ' + canvas.offsetHeight);
                    
                    const ctx = canvas.getContext('2d');
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasContent = imageData.data.some(pixel => pixel !== 0);
                    logToConsole('Canvas has content: ' + hasContent);
                    
                    if (hasContent) {
                        logToConsole('Canvas content detected - QR code may be present');
                    } else {
                        logToConsole('Canvas is empty - QR generation may have failed');
                    }

                    showStatus('✅ Canvas inspected - see console output', 'success');
                } else {
                    logToConsole('Canvas element not found');
                    showStatus('❌ Canvas element not found', 'error');
                }
            } catch (error) {
                logToConsole('Error inspecting canvas: ' + error.message);
                showStatus('❌ Failed to inspect canvas', 'error');
            }
        }

        function testQRGeneration() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeWindow = iframe.contentWindow;

                if (iframeWindow.qrShareDirect) {
                    logToConsole('=== Testing QR Generation ===');
                    
                    const testData = {
                        cookies: [{ name: 'test', value: 'debug123', domain: '.example.com', path: '/' }],
                        url: 'https://example.com',
                        title: 'Debug Test',
                        timestamp: Date.now()
                    };

                    iframeWindow.qrShareDirect.generateDirectLoginQR(testData, 'js-qr-canvas-share')
                        .then(url => {
                            logToConsole('QR generation successful');
                            logToConsole('Generated URL length: ' + url.length);
                            logToConsole('URL preview: ' + url.substring(0, 100) + '...');
                            showStatus('✅ QR generation test completed', 'success');
                        })
                        .catch(error => {
                            logToConsole('QR generation failed: ' + error.message);
                            showStatus('❌ QR generation test failed', 'error');
                        });
                } else {
                    logToConsole('qrShareDirect module not available');
                    showStatus('❌ qrShareDirect module not loaded', 'error');
                }
            } catch (error) {
                logToConsole('Error testing QR generation: ' + error.message);
                showStatus('❌ QR generation test error', 'error');
            }
        }

        function viewConsole() {
            logToConsole('=== Browser Console Check ===');
            logToConsole('Check the browser console (F12) for additional error messages');
            logToConsole('Look for QRious library errors, canvas errors, or JavaScript errors');
            showStatus('📊 Check browser console (F12) for detailed logs', 'warning');
        }

        function fixCanvasSize() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeDoc = iframe.contentDocument;
                const canvas = iframeDoc.getElementById('js-qr-canvas-share');

                if (canvas) {
                    canvas.width = 200;
                    canvas.height = 200;
                    canvas.style.width = '200px';
                    canvas.style.height = '200px';
                    canvas.style.display = 'block';
                    
                    logToConsole('Canvas size fixed: 200x200px');
                    showStatus('✅ Canvas size fixed', 'success');
                } else {
                    showStatus('❌ Canvas not found', 'error');
                }
            } catch (error) {
                logToConsole('Error fixing canvas size: ' + error.message);
                showStatus('❌ Failed to fix canvas size', 'error');
            }
        }

        function forceQRGeneration() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeDoc = iframe.contentDocument;
                const generateBtn = iframeDoc.getElementById('js-generate-qr-share');

                if (generateBtn) {
                    logToConsole('Forcing QR generation by clicking button...');
                    generateBtn.click();
                    showStatus('✅ QR generation forced', 'success');
                } else {
                    showStatus('❌ Generate button not found', 'error');
                }
            } catch (error) {
                logToConsole('Error forcing QR generation: ' + error.message);
                showStatus('❌ Failed to force QR generation', 'error');
            }
        }

        function testFallback() {
            try {
                const iframe = document.getElementById('extension-iframe');
                const iframeWindow = iframe.contentWindow;
                const iframeDoc = iframe.contentDocument;
                const canvas = iframeDoc.getElementById('js-qr-canvas-share');

                if (iframeWindow.qrShareDirect && canvas) {
                    logToConsole('Testing fallback QR generation...');
                    const testURL = 'https://example.com/test-fallback';
                    iframeWindow.qrShareDirect.showTextFallback(canvas, testURL);
                    showStatus('✅ Fallback test completed', 'success');
                } else {
                    showStatus('❌ Required components not found', 'error');
                }
            } catch (error) {
                logToConsole('Error testing fallback: ' + error.message);
                showStatus('❌ Fallback test failed', 'error');
            }
        }

        function generateTestURL() {
            try {
                const testData = {
                    cookies: [
                        { name: 'debug_session', value: 'test123', domain: '.example.com', path: '/' }
                    ],
                    url: 'https://example.com/debug',
                    title: 'Debug Test Page',
                    timestamp: Date.now()
                };

                const encodedData = btoa(JSON.stringify(testData));
                
                const htmlContent = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Mobile Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; }
        .btn { background: #d94343; color: white; padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 Debug Mobile Test</h1>
        <p>Testing mobile URL generation and decoding</p>
        <button class="btn" onclick="testDecode()">Test Decode</button>
        <div id="result" style="margin-top: 20px;"></div>
    </div>
    <script>
        const encodedData = ${JSON.stringify(encodedData)};
        function testDecode() {
            try {
                const decoded = atob(encodedData);
                const data = JSON.parse(decoded);
                document.getElementById('result').innerHTML = 
                    '<div style="background: #d4edda; padding: 15px; border-radius: 8px; color: #155724;">' +
                    '✅ Decode successful!<br>' +
                    'Cookies: ' + data.cookies.length + '<br>' +
                    'URL: ' + data.url + '<br>' +
                    'Title: ' + data.title +
                    '</div>';
            } catch (e) {
                document.getElementById('result').innerHTML = 
                    '<div style="background: #f8d7da; padding: 15px; border-radius: 8px; color: #721c24;">' +
                    '❌ Decode failed: ' + e.message +
                    '</div>';
            }
        }
    </script>
</body>
</html>`;

                testMobileURL = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);
                
                document.getElementById('url-preview').style.display = 'block';
                document.getElementById('url-content').textContent = testMobileURL.substring(0, 200) + '...';
                document.getElementById('mobile-test-btn').style.display = 'inline-block';
                
                logToConsole('Test mobile URL generated');
                logToConsole('URL length: ' + testMobileURL.length);
                showStatus('✅ Test URL generated successfully', 'success');
                
            } catch (error) {
                logToConsole('Error generating test URL: ' + error.message);
                showStatus('❌ Failed to generate test URL', 'error');
            }
        }

        function openMobileTest() {
            if (testMobileURL) {
                window.open(testMobileURL, '_blank', 'width=400,height=600');
                showStatus('✅ Mobile test opened', 'success');
            } else {
                showStatus('❌ No test URL available', 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logToConsole('Debug panel initialized');
            logToConsole('Extension iframe loading...');
            
            const iframe = document.getElementById('extension-iframe');
            iframe.onload = function() {
                logToConsole('Extension iframe loaded successfully');
                setTimeout(() => {
                    checkExtensionState();
                }, 1000);
            };
        });
    </script>
</body>
</html>
