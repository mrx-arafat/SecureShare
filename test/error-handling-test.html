<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handling System Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .error-demo {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            min-height: 200px;
        }
        .error-stats {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .severity-error { border-left: 4px solid #dc3545; }
        .severity-warning { border-left: 4px solid #ffc107; }
        .severity-info { border-left: 4px solid #17a2b8; }
        .mobile-preview {
            max-width: 400px;
            margin: 20px auto;
            border: 2px solid #333;
            border-radius: 20px;
            overflow: hidden;
            background: white;
        }
        .mobile-preview iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
    </style>
</head>
<body>
    <h1>🛡️ Error Handling System Tests</h1>
    <p>Test comprehensive error handling, retry mechanisms, and user-friendly error messages</p>

    <div class="test-container">
        <h2>Error Handler Status</h2>
        <div id="error-handler-status" class="error-stats">
            <p>Loading error handler status...</p>
        </div>
        <button onclick="checkErrorHandlerStatus()">🔍 Check Status</button>
        <button onclick="initializeErrorHandler()">🛡️ Initialize Error Handler</button>
    </div>

    <div class="test-container">
        <h2>Error Simulation</h2>
        <p>Test different error scenarios and their handling:</p>
        <button onclick="simulateExpiredLink()">⏰ Expired Link</button>
        <button onclick="simulateInvalidSession()">🚫 Invalid Session</button>
        <button onclick="simulateCookieFailure()">🍪 Cookie Failure</button>
        <button onclick="simulateNetworkError()">🌐 Network Error</button>
        <button onclick="simulateBrowserIncompatible()">🌐 Browser Incompatible</button>
        <button onclick="simulateExtensionMissing()">🔌 Extension Missing</button>
        <button onclick="simulatePermissionDenied()">🔒 Permission Denied</button>
        <button onclick="simulateUnknownError()">❓ Unknown Error</button>
    </div>

    <div class="test-container">
        <h2>Retry Mechanism Tests</h2>
        <button onclick="testRetryMechanism()">🔄 Test Retry Logic</button>
        <button onclick="testExponentialBackoff()">📈 Test Exponential Backoff</button>
        <button onclick="testMaxRetries()">🛑 Test Max Retries</button>
        <button onclick="clearRetryAttempts()">🧹 Clear Retry Attempts</button>
    </div>

    <div class="test-container">
        <h2>Error Demo Area</h2>
        <div class="error-demo" id="error-demo">
            <p>Error messages will appear here when simulated</p>
        </div>
        <button onclick="clearErrorDemo()">🧹 Clear Demo</button>
    </div>

    <div class="test-container">
        <h2>Error Statistics</h2>
        <div id="error-statistics" class="error-stats">
            <p>No error statistics available</p>
        </div>
        <button onclick="updateErrorStats()">📊 Update Statistics</button>
    </div>

    <div class="test-container">
        <h2>Error Log</h2>
        <div id="error-log" class="error-log">
            <p>Error log will appear here...</p>
        </div>
        <button onclick="refreshErrorLog()">🔄 Refresh Log</button>
        <button onclick="clearErrorLog()">🗑️ Clear Log</button>
    </div>

    <div class="test-container">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">🚀 Run All Tests</button>
        <button onclick="testErrorTypes()">🎯 Test Error Types</button>
        <button onclick="testUserFriendlyMessages()">💬 Test User Messages</button>
        <button onclick="testGracefulDegradation()">🛡️ Test Graceful Degradation</button>
        <button onclick="testErrorLogging()">📝 Test Error Logging</button>
        <button onclick="clearResults()">🗑️ Clear Results</button>
    </div>

    <div class="test-container">
        <h2>Mobile Error Handling Preview</h2>
        <p>Preview how errors are handled on the mobile session page:</p>
        <div class="mobile-preview">
            <iframe id="mobile-iframe" src="about:blank"></iframe>
        </div>
        <button onclick="loadMobileWithError()">📱 Load Mobile with Error</button>
        <button onclick="loadMobileNormal()">📱 Load Mobile Normal</button>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <!-- Load error handler module -->
    <script src="../mobile/js/errorHandler.js"></script>

    <!-- Test Suite -->
    <script>
        let testResults = [];
        let testCount = 0;
        let passCount = 0;

        function addTestResult(name, passed, message, details = null) {
            testCount++;
            if (passed) passCount++;
            
            testResults.push({
                name,
                passed,
                message,
                details,
                timestamp: new Date().toLocaleTimeString()
            });
            
            updateTestDisplay();
        }

        function updateTestDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            // Add summary
            const summary = document.createElement('div');
            summary.className = 'test-result test-info';
            summary.textContent = `Tests: ${testCount} | Passed: ${passCount} | Failed: ${testCount - passCount}`;
            container.appendChild(summary);
            
            // Add individual results
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                
                let content = `[${result.timestamp}] ${result.passed ? '✅' : '❌'} ${result.name}: ${result.message}`;
                if (result.details) {
                    content += `\nDetails: ${JSON.stringify(result.details, null, 2)}`;
                }
                
                div.textContent = content;
                container.appendChild(div);
            });
        }

        function clearResults() {
            testResults = [];
            testCount = 0;
            passCount = 0;
            updateTestDisplay();
        }

        function checkErrorHandlerStatus() {
            const statusEl = document.getElementById('error-handler-status');
            
            if (window.ErrorHandler) {
                const stats = window.ErrorHandler.getErrorStats ? window.ErrorHandler.getErrorStats() : {};
                statusEl.innerHTML = `
                    <h4>✅ Error Handler Loaded</h4>
                    <p><strong>Total Errors:</strong> ${stats.totalErrors || 0}</p>
                    <p><strong>Error Types:</strong> ${Object.keys(stats.errorsByType || {}).length}</p>
                    <p><strong>Retry Attempts:</strong> ${Object.keys(stats.retryAttempts || {}).length}</p>
                `;
            } else {
                statusEl.innerHTML = '<h4>❌ Error Handler Not Loaded</h4>';
            }
        }

        function initializeErrorHandler() {
            if (window.ErrorHandler) {
                window.ErrorHandler.initialize();
                addTestResult('Error Handler Initialization', true, 'Error handler initialized successfully');
                checkErrorHandlerStatus();
            } else {
                addTestResult('Error Handler Initialization', false, 'Error handler module not loaded');
            }
        }

        function simulateExpiredLink() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Session has expired',
                    window.ErrorHandler.ERROR_TYPES.EXPIRED_LINK,
                    { sessionId: 'test-session-123', expiresAt: Date.now() - 1000 }
                );
                addTestResult('Expired Link Simulation', true, 'Expired link error simulated');
            } else {
                addTestResult('Expired Link Simulation', false, 'Error handler not available');
            }
        }

        function simulateInvalidSession() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Invalid session data format',
                    window.ErrorHandler.ERROR_TYPES.INVALID_SESSION,
                    { sessionId: 'invalid-session', reason: 'corrupted_data' }
                );
                addTestResult('Invalid Session Simulation', true, 'Invalid session error simulated');
            } else {
                addTestResult('Invalid Session Simulation', false, 'Error handler not available');
            }
        }

        function simulateCookieFailure() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Failed to apply cookies',
                    window.ErrorHandler.ERROR_TYPES.COOKIE_FAILURE,
                    { cookieCount: 5, appliedCount: 0, reason: 'blocked_by_browser' }
                );
                addTestResult('Cookie Failure Simulation', true, 'Cookie failure error simulated');
            } else {
                addTestResult('Cookie Failure Simulation', false, 'Error handler not available');
            }
        }

        function simulateNetworkError() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Network request failed',
                    window.ErrorHandler.ERROR_TYPES.NETWORK_ERROR,
                    { url: 'http://localhost:3001/api/sessions/test', status: 0, timeout: true }
                );
                addTestResult('Network Error Simulation', true, 'Network error simulated');
            } else {
                addTestResult('Network Error Simulation', false, 'Error handler not available');
            }
        }

        function simulateBrowserIncompatible() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Browser lacks required features',
                    window.ErrorHandler.ERROR_TYPES.BROWSER_INCOMPATIBLE,
                    { missingFeatures: ['fetch', 'promises'], browser: 'IE11' }
                );
                addTestResult('Browser Incompatible Simulation', true, 'Browser incompatible error simulated');
            } else {
                addTestResult('Browser Incompatible Simulation', false, 'Error handler not available');
            }
        }

        function simulateExtensionMissing() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'SecureShare extension not found',
                    window.ErrorHandler.ERROR_TYPES.EXTENSION_MISSING,
                    { browser: 'Chrome', extensionId: 'secureshare-extension' }
                );
                addTestResult('Extension Missing Simulation', true, 'Extension missing error simulated');
            } else {
                addTestResult('Extension Missing Simulation', false, 'Error handler not available');
            }
        }

        function simulatePermissionDenied() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'Permission denied for cookies',
                    window.ErrorHandler.ERROR_TYPES.PERMISSION_DENIED,
                    { permission: 'cookies', origin: window.location.origin }
                );
                addTestResult('Permission Denied Simulation', true, 'Permission denied error simulated');
            } else {
                addTestResult('Permission Denied Simulation', false, 'Error handler not available');
            }
        }

        function simulateUnknownError() {
            if (window.ErrorHandler) {
                window.ErrorHandler.handleError(
                    'An unexpected error occurred',
                    window.ErrorHandler.ERROR_TYPES.UNKNOWN_ERROR,
                    { stack: 'Error stack trace...', userAgent: navigator.userAgent }
                );
                addTestResult('Unknown Error Simulation', true, 'Unknown error simulated');
            } else {
                addTestResult('Unknown Error Simulation', false, 'Error handler not available');
            }
        }

        function testRetryMechanism() {
            if (window.ErrorHandler) {
                // Test retry with mock function
                let retryCount = 0;
                const mockRetryFunction = () => {
                    retryCount++;
                    console.log(`Mock retry attempt: ${retryCount}`);
                };
                
                window.ErrorHandler.retryOperation('test_operation', mockRetryFunction, { test: true });
                
                addTestResult('Retry Mechanism', true, 'Retry mechanism tested', { retryCount });
            } else {
                addTestResult('Retry Mechanism', false, 'Error handler not available');
            }
        }

        function testExponentialBackoff() {
            if (window.ErrorHandler) {
                // Test exponential backoff timing
                const baseDelay = window.ErrorHandler.baseRetryDelay;
                const delays = [];
                
                for (let i = 0; i < 3; i++) {
                    const delay = baseDelay * Math.pow(2, i);
                    delays.push(delay);
                }
                
                addTestResult('Exponential Backoff', true, 'Backoff timing calculated', { delays });
            } else {
                addTestResult('Exponential Backoff', false, 'Error handler not available');
            }
        }

        function testMaxRetries() {
            if (window.ErrorHandler) {
                const maxRetries = window.ErrorHandler.maxRetries;
                addTestResult('Max Retries', true, `Max retries configured: ${maxRetries}`, { maxRetries });
            } else {
                addTestResult('Max Retries', false, 'Error handler not available');
            }
        }

        function clearRetryAttempts() {
            if (window.ErrorHandler && window.ErrorHandler.retryAttempts) {
                window.ErrorHandler.retryAttempts.clear();
                addTestResult('Clear Retry Attempts', true, 'Retry attempts cleared');
            } else {
                addTestResult('Clear Retry Attempts', false, 'Error handler not available');
            }
        }

        function clearErrorDemo() {
            const demoEl = document.getElementById('error-demo');
            demoEl.innerHTML = '<p>Error messages will appear here when simulated</p>';
        }

        function updateErrorStats() {
            if (window.ErrorHandler && window.ErrorHandler.getErrorStats) {
                const stats = window.ErrorHandler.getErrorStats();
                const statsEl = document.getElementById('error-statistics');
                
                statsEl.innerHTML = `
                    <h4>📊 Error Statistics</h4>
                    <p><strong>Total Errors:</strong> ${stats.totalErrors}</p>
                    <p><strong>Error Types:</strong></p>
                    <ul>
                        ${Object.entries(stats.errorsByType).map(([type, count]) => 
                            `<li>${type}: ${count}</li>`
                        ).join('')}
                    </ul>
                    <p><strong>Active Retry Attempts:</strong> ${Object.keys(stats.retryAttempts).length}</p>
                `;
                
                addTestResult('Error Statistics', true, 'Statistics updated', stats);
            } else {
                addTestResult('Error Statistics', false, 'Error handler not available');
            }
        }

        function refreshErrorLog() {
            if (window.ErrorHandler && window.ErrorHandler.errorLog) {
                const logEl = document.getElementById('error-log');
                const logs = window.ErrorHandler.errorLog;
                
                if (logs.length === 0) {
                    logEl.innerHTML = '<p>No errors logged yet</p>';
                } else {
                    logEl.innerHTML = logs.map(log => `
                        <div class="log-entry">
                            <strong>[${log.timestamp}]</strong> ${log.type}: ${log.message}
                        </div>
                    `).join('');
                }
                
                addTestResult('Error Log Refresh', true, `Displayed ${logs.length} log entries`);
            } else {
                addTestResult('Error Log Refresh', false, 'Error handler not available');
            }
        }

        function clearErrorLog() {
            if (window.ErrorHandler && window.ErrorHandler.errorLog) {
                window.ErrorHandler.errorLog.length = 0;
                refreshErrorLog();
                addTestResult('Clear Error Log', true, 'Error log cleared');
            } else {
                addTestResult('Clear Error Log', false, 'Error handler not available');
            }
        }

        function testErrorTypes() {
            if (window.ErrorHandler) {
                const errorTypes = window.ErrorHandler.ERROR_TYPES;
                const typeCount = Object.keys(errorTypes).length;
                
                addTestResult('Error Types', true, `${typeCount} error types defined`, errorTypes);
            } else {
                addTestResult('Error Types', false, 'Error handler not available');
            }
        }

        function testUserFriendlyMessages() {
            // Test that error messages are user-friendly
            simulateExpiredLink();
            setTimeout(() => {
                const errorState = document.getElementById('error-state');
                if (errorState && !errorState.classList.contains('hidden')) {
                    addTestResult('User-Friendly Messages', true, 'Error message displayed to user');
                } else {
                    addTestResult('User-Friendly Messages', false, 'No error message displayed');
                }
            }, 100);
        }

        function testGracefulDegradation() {
            if (window.ErrorHandler) {
                const result = window.ErrorHandler.gracefulDegradation();
                addTestResult('Graceful Degradation', result, `Graceful degradation: ${result ? 'passed' : 'failed'}`);
            } else {
                addTestResult('Graceful Degradation', false, 'Error handler not available');
            }
        }

        function testErrorLogging() {
            if (window.ErrorHandler) {
                const initialLogCount = window.ErrorHandler.errorLog.length;
                
                // Trigger an error to test logging
                window.ErrorHandler.handleError('Test error for logging', 'test_error', { test: true });
                
                const newLogCount = window.ErrorHandler.errorLog.length;
                const logged = newLogCount > initialLogCount;
                
                addTestResult('Error Logging', logged, `Error logging: ${logged ? 'working' : 'failed'}`, {
                    initialCount: initialLogCount,
                    newCount: newLogCount
                });
            } else {
                addTestResult('Error Logging', false, 'Error handler not available');
            }
        }

        function loadMobileWithError() {
            const iframe = document.getElementById('mobile-iframe');
            iframe.src = '../mobile/index.html#error=expired_link';
        }

        function loadMobileNormal() {
            const iframe = document.getElementById('mobile-iframe');
            iframe.src = '../mobile/index.html';
        }

        async function runAllTests() {
            clearResults();
            addTestResult('Test Suite', true, 'Starting error handling system tests...');
            
            initializeErrorHandler();
            testErrorTypes();
            testRetryMechanism();
            testExponentialBackoff();
            testMaxRetries();
            testGracefulDegradation();
            testErrorLogging();
            
            // Test error simulations
            simulateExpiredLink();
            await new Promise(resolve => setTimeout(resolve, 100));
            simulateNetworkError();
            await new Promise(resolve => setTimeout(resolve, 100));
            simulateCookieFailure();
            
            updateErrorStats();
            refreshErrorLog();
            
            addTestResult('Test Suite', true, 'All error handling tests completed!');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkErrorHandlerStatus();
            updateTestDisplay();
        });
    </script>
</body>
</html>
