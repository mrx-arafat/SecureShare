<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîç Mobile Debug Test</h1>
    
    <div class="test-section">
        <h3>API Connection Test</h3>
        <button onclick="testAPI()">Test Session Storage API</button>
        <button onclick="testMobileServer()">Test Mobile Server</button>
        <div id="api-status" class="status info">Ready to test...</div>
    </div>

    <div class="test-section">
        <h3>Session Retrieval Test</h3>
        <input type="text" id="session-id" placeholder="Session ID" style="width: 300px; padding: 8px;">
        <input type="text" id="encryption-key" placeholder="Encryption Key" style="width: 300px; padding: 8px;">
        <br><br>
        <button onclick="testSessionRetrieval()">Test Session Retrieval</button>
        <div id="session-status" class="status info">Enter session details above...</div>
    </div>

    <div class="test-section">
        <h3>Quick Test with Fresh Session</h3>
        <button onclick="createAndTestSession()">Create & Test Fresh Session</button>
        <div id="quick-status" class="status info">Ready for quick test...</div>
    </div>

    <div class="test-section">
        <h3>Debug Log</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="debug-log" class="log">Debug log will appear here...</div>
    </div>

    <script>
        function log(message) {
            const logEl = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateStatus(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `status ${type}`;
        }

        async function testAPI() {
            log('üß™ Testing Session Storage API...');
            updateStatus('api-status', 'Testing API connection...', 'info');

            try {
                const response = await fetch('http://localhost:3001/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API Health: ${data.status}, Active Sessions: ${data.activeSessions}`);
                    updateStatus('api-status', `‚úÖ API Healthy (${data.activeSessions} sessions)`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå API Test Failed: ${error.message}`);
                updateStatus('api-status', `‚ùå API Failed: ${error.message}`, 'error');
            }
        }

        async function testMobileServer() {
            log('üß™ Testing Mobile Server...');
            
            try {
                const response = await fetch('http://localhost:6969/health');
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Mobile Server: ${data.status} on port ${data.port}`);
                    updateStatus('api-status', `‚úÖ Mobile Server Healthy`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Mobile Server Test Failed: ${error.message}`);
                updateStatus('api-status', `‚ùå Mobile Server Failed: ${error.message}`, 'error');
            }
        }

        async function testSessionRetrieval() {
            const sessionId = document.getElementById('session-id').value.trim();
            const encryptionKey = document.getElementById('encryption-key').value.trim();

            if (!sessionId || !encryptionKey) {
                updateStatus('session-status', '‚ùå Please enter both session ID and encryption key', 'error');
                return;
            }

            log(`üîç Testing session retrieval: ${sessionId}`);
            updateStatus('session-status', 'Retrieving session...', 'info');

            try {
                const response = await fetch(`http://localhost:3001/api/sessions/${sessionId}?key=${encryptionKey}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Session Retrieved: ${data.sessionData.domain} (${data.sessionData.cookies.length} cookies)`);
                    updateStatus('session-status', `‚úÖ Session Retrieved: ${data.sessionData.domain}`, 'success');
                    
                    // Log session details
                    log(`üìä Session Details:`);
                    log(`   URL: ${data.sessionData.url}`);
                    log(`   Domain: ${data.sessionData.domain}`);
                    log(`   Cookies: ${data.sessionData.cookies.length}`);
                    log(`   Access Count: ${data.metadata.accessCount}`);
                    log(`   Time Remaining: ${Math.round(data.metadata.timeRemaining / 1000)}s`);
                    
                } else if (response.status === 404) {
                    log(`‚ùå Session not found or expired: ${sessionId}`);
                    updateStatus('session-status', '‚ùå Session not found or expired', 'error');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Session Retrieval Failed: ${error.message}`);
                updateStatus('session-status', `‚ùå Failed: ${error.message}`, 'error');
            }
        }

        async function createAndTestSession() {
            log('üöÄ Creating fresh session for testing...');
            updateStatus('quick-status', 'Creating test session...', 'info');

            try {
                // Create test session
                const sessionData = {
                    url: 'https://www.example.com/',
                    title: 'Example Site',
                    domain: 'example.com',
                    cookies: [
                        { name: 'test_cookie', value: 'test_value_123', domain: '.example.com', secure: true }
                    ]
                };

                const encryptionKey = 'abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890';

                const createResponse = await fetch('http://localhost:3001/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionData: sessionData,
                        encryptionKey: encryptionKey,
                        ttl: 1800
                    })
                });

                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Failed to create session');
                }

                const createResult = await createResponse.json();
                log(`‚úÖ Session Created: ${createResult.sessionId}`);

                // Auto-fill the form
                document.getElementById('session-id').value = createResult.sessionId;
                document.getElementById('encryption-key').value = encryptionKey;

                // Test retrieval
                await testSessionRetrieval();

                updateStatus('quick-status', `‚úÖ Quick test completed: ${createResult.sessionId}`, 'success');

            } catch (error) {
                log(`‚ùå Quick Test Failed: ${error.message}`);
                updateStatus('quick-status', `‚ùå Failed: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = 'Debug log cleared...\n';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß Mobile Debug Test initialized');
            log('üì° Testing connection to localhost:3001 and localhost:6969');
        });
    </script>
</body>
</html>
