<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Capture Unit Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .mock-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .test-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>🧪 Session Capture Unit Tests</h1>
    <p>Comprehensive unit testing for session capture functionality with mocked Chrome APIs</p>

    <div class="test-stats">
        <div class="stat-box">
            <div class="stat-number" id="total-tests">0</div>
            <div>Total Tests</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="passed-tests">0</div>
            <div>Passed</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="failed-tests">0</div>
            <div>Failed</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="success-rate">0%</div>
            <div>Success Rate</div>
        </div>
    </div>

    <div class="test-container">
        <h2>Chrome API Mocks</h2>
        <div class="mock-data" id="chrome-api-status">
            <p>Chrome API mocks will be initialized here</p>
        </div>
        <button onclick="initializeMocks()">🔧 Initialize Mocks</button>
        <button onclick="testMockFunctionality()">✅ Test Mock APIs</button>
    </div>

    <div class="test-container">
        <h2>Session Capture Module Tests</h2>
        <div class="mock-data" id="session-capture-status">
            <p>Session capture module status will appear here</p>
        </div>
        <button onclick="testSessionCaptureModule()">📦 Test Module Loading</button>
        <button onclick="testCurrentTabCapture()">🌐 Test Current Tab</button>
        <button onclick="testCookieExtraction()">🍪 Test Cookie Extraction</button>
    </div>

    <div class="test-container">
        <h2>Cookie Filtering Tests</h2>
        <div class="mock-data" id="cookie-filtering-results">
            <p>Cookie filtering test results will appear here</p>
        </div>
        <button onclick="testEssentialCookieFiltering()">🔍 Test Essential Cookies</button>
        <button onclick="testTrackingCookieRemoval()">🚫 Test Tracking Removal</button>
        <button onclick="testCookieValidation()">✅ Test Cookie Validation</button>
    </div>

    <div class="test-container">
        <h2>Session Data Validation Tests</h2>
        <div class="mock-data" id="validation-results">
            <p>Validation test results will appear here</p>
        </div>
        <button onclick="testURLValidation()">🌐 Test URL Validation</button>
        <button onclick="testSessionDataStructure()">📋 Test Data Structure</button>
        <button onclick="testEdgeCases()">⚠️ Test Edge Cases</button>
    </div>

    <div class="test-container">
        <h2>Performance Tests</h2>
        <div class="mock-data" id="performance-results">
            <p>Performance test results will appear here</p>
        </div>
        <button onclick="testCapturePerformance()">⚡ Test Capture Speed</button>
        <button onclick="testMemoryUsage()">💾 Test Memory Usage</button>
        <button onclick="testLargeCookieSets()">📊 Test Large Cookie Sets</button>
    </div>

    <div class="test-container">
        <h2>Error Handling Tests</h2>
        <div class="mock-data" id="error-handling-results">
            <p>Error handling test results will appear here</p>
        </div>
        <button onclick="testAPIFailures()">❌ Test API Failures</button>
        <button onclick="testInvalidInputs()">🚫 Test Invalid Inputs</button>
        <button onclick="testPermissionErrors()">🔒 Test Permission Errors</button>
    </div>

    <div class="test-container">
        <h2>Test Controls</h2>
        <button onclick="runAllUnitTests()">🚀 Run All Unit Tests</button>
        <button onclick="runQuickTests()">⚡ Quick Test Suite</button>
        <button onclick="runPerformanceTests()">📊 Performance Suite</button>
        <button onclick="generateTestReport()">📄 Generate Report</button>
        <button onclick="clearResults()">🗑️ Clear Results</button>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="test-results"></div>
    </div>

    <!-- Mock Chrome APIs -->
    <script>
        // Global test state
        let testResults = [];
        let testCount = 0;
        let passCount = 0;
        let mockChrome = null;

        // Mock Chrome APIs for testing
        function initializeMocks() {
            mockChrome = {
                tabs: {
                    query: function(queryInfo, callback) {
                        // Mock active tab data
                        const mockTab = {
                            id: 1,
                            url: 'https://www.netflix.com/browse',
                            title: 'Netflix - Watch TV Shows Online, Watch Movies Online',
                            favIconUrl: 'https://www.netflix.com/favicon.ico',
                            active: true,
                            windowId: 1
                        };
                        setTimeout(() => callback([mockTab]), 10);
                    }
                },
                cookies: {
                    getAll: function(details, callback) {
                        // Mock cookie data for different scenarios
                        const mockCookies = [
                            {
                                name: 'NetflixId',
                                value: 'v%3D2%26mac%3DAQEAEAABAAFRe',
                                domain: '.netflix.com',
                                path: '/',
                                secure: true,
                                httpOnly: false,
                                sameSite: 'lax'
                            },
                            {
                                name: 'SecureNetflixId',
                                value: 'v%3D2%26mac%3DAQEAEAABAAFRe-secure',
                                domain: '.netflix.com',
                                path: '/',
                                secure: true,
                                httpOnly: true,
                                sameSite: 'strict'
                            },
                            {
                                name: '_ga',
                                value: 'GA1.2.1234567890.1234567890',
                                domain: '.netflix.com',
                                path: '/',
                                secure: false,
                                httpOnly: false,
                                sameSite: 'lax'
                            },
                            {
                                name: '_gid',
                                value: 'GA1.2.0987654321.0987654321',
                                domain: '.netflix.com',
                                path: '/',
                                secure: false,
                                httpOnly: false,
                                sameSite: 'lax'
                            },
                            {
                                name: 'session_token',
                                value: 'abc123xyz789sessiontoken',
                                domain: '.netflix.com',
                                path: '/',
                                secure: true,
                                httpOnly: true,
                                sameSite: 'strict'
                            }
                        ];
                        setTimeout(() => callback(mockCookies), 10);
                    }
                },
                runtime: {
                    lastError: null
                }
            };

            // Replace global chrome object for testing
            window.chrome = mockChrome;

            const statusEl = document.getElementById('chrome-api-status');
            statusEl.innerHTML = `
                <h4>✅ Chrome API Mocks Initialized</h4>
                <p><strong>Mocked APIs:</strong></p>
                <ul>
                    <li>chrome.tabs.query() - Returns mock Netflix tab</li>
                    <li>chrome.cookies.getAll() - Returns 5 mock cookies (2 essential, 2 tracking, 1 session)</li>
                    <li>chrome.runtime.lastError - Error handling mock</li>
                </ul>
                <p><strong>Mock Data Ready:</strong> Netflix session with authentication cookies</p>
            `;

            addTestResult('Chrome API Mocks', true, 'Successfully initialized mock Chrome APIs');
        }

        function testMockFunctionality() {
            if (!mockChrome) {
                addTestResult('Mock Functionality', false, 'Mocks not initialized');
                return;
            }

            // Test tabs API
            mockChrome.tabs.query({active: true, currentWindow: true}, (tabs) => {
                const tabTest = tabs && tabs.length > 0 && tabs[0].url.includes('netflix.com');
                addTestResult('Mock Tabs API', tabTest, `Tab mock working: ${tabTest}`);
            });

            // Test cookies API
            mockChrome.cookies.getAll({url: 'https://www.netflix.com'}, (cookies) => {
                const cookieTest = cookies && cookies.length === 5;
                addTestResult('Mock Cookies API', cookieTest, `Cookie mock working: ${cookieTest}, Count: ${cookies ? cookies.length : 0}`);
            });
        }

        // Test utility functions
        function addTestResult(name, passed, message, details = null) {
            testCount++;
            if (passed) passCount++;
            
            testResults.push({
                name,
                passed,
                message,
                details,
                timestamp: new Date().toLocaleTimeString()
            });
            
            updateTestDisplay();
            updateTestStats();
        }

        function updateTestDisplay() {
            const container = document.getElementById('test-results');
            container.innerHTML = '';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
                
                let content = `[${result.timestamp}] ${result.passed ? '✅' : '❌'} ${result.name}: ${result.message}`;
                if (result.details) {
                    content += `\nDetails: ${JSON.stringify(result.details, null, 2)}`;
                }
                
                div.textContent = content;
                container.appendChild(div);
            });
        }

        function updateTestStats() {
            document.getElementById('total-tests').textContent = testCount;
            document.getElementById('passed-tests').textContent = passCount;
            document.getElementById('failed-tests').textContent = testCount - passCount;
            document.getElementById('success-rate').textContent = testCount > 0 ? Math.round((passCount / testCount) * 100) + '%' : '0%';
        }

        function clearResults() {
            testResults = [];
            testCount = 0;
            passCount = 0;
            updateTestDisplay();
            updateTestStats();
        }

        // Load session capture module for testing
        function testSessionCaptureModule() {
            const statusEl = document.getElementById('session-capture-status');
            
            if (window.SessionCapture) {
                statusEl.innerHTML = `
                    <h4>✅ SessionCapture Module Loaded</h4>
                    <p><strong>Available Methods:</strong></p>
                    <ul>
                        <li>captureCurrentSession()</li>
                        <li>extractSessionCookies(url)</li>
                        <li>filterEssentialCookies(cookies)</li>
                        <li>validateSessionData(sessionData)</li>
                        <li>createSessionPayload(sessionData)</li>
                    </ul>
                `;
                addTestResult('SessionCapture Module', true, 'Module loaded successfully');
            } else {
                statusEl.innerHTML = '<h4>❌ SessionCapture Module Not Found</h4><p>Module may not be loaded or path incorrect</p>';
                addTestResult('SessionCapture Module', false, 'Module not available');
            }
        }

        function testCurrentTabCapture() {
            if (!window.SessionCapture || !mockChrome) {
                addTestResult('Current Tab Capture', false, 'Dependencies not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            sessionCapture.getCurrentTab().then(tab => {
                const isValid = tab && tab.url && tab.title;
                const isNetflix = tab.url.includes('netflix.com');
                
                addTestResult('Current Tab Capture', isValid && isNetflix, 
                    `Tab captured: ${isValid}, Netflix detected: ${isNetflix}`, {
                        url: tab.url,
                        title: tab.title,
                        id: tab.id
                    });
            }).catch(error => {
                addTestResult('Current Tab Capture', false, `Error: ${error.message}`);
            });
        }

        function testCookieExtraction() {
            if (!window.SessionCapture || !mockChrome) {
                addTestResult('Cookie Extraction', false, 'Dependencies not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            sessionCapture.extractSessionCookies('https://www.netflix.com').then(cookies => {
                const hasNetflixId = cookies.some(c => c.name === 'NetflixId');
                const hasSessionToken = cookies.some(c => c.name === 'session_token');
                const hasTrackingCookies = cookies.some(c => c.name.startsWith('_ga'));
                
                addTestResult('Cookie Extraction', hasNetflixId && hasSessionToken, 
                    `Cookies extracted: ${cookies.length}, Netflix ID: ${hasNetflixId}, Session: ${hasSessionToken}`, {
                        totalCookies: cookies.length,
                        hasEssential: hasNetflixId && hasSessionToken,
                        hasTracking: hasTrackingCookies
                    });
            }).catch(error => {
                addTestResult('Cookie Extraction', false, `Error: ${error.message}`);
            });
        }

        function testEssentialCookieFiltering() {
            if (!window.SessionCapture || !mockChrome) {
                addTestResult('Essential Cookie Filtering', false, 'Dependencies not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            // Get all cookies first
            mockChrome.cookies.getAll({url: 'https://www.netflix.com'}, (allCookies) => {
                const filteredCookies = sessionCapture.filterEssentialCookies(allCookies);
                
                const originalCount = allCookies.length;
                const filteredCount = filteredCookies.length;
                const hasEssential = filteredCookies.some(c => c.name === 'NetflixId' || c.name === 'session_token');
                const hasTracking = filteredCookies.some(c => c.name.startsWith('_ga'));
                
                const resultsEl = document.getElementById('cookie-filtering-results');
                resultsEl.innerHTML = `
                    <h4>🔍 Essential Cookie Filtering Results</h4>
                    <p><strong>Original Cookies:</strong> ${originalCount}</p>
                    <p><strong>Filtered Cookies:</strong> ${filteredCount}</p>
                    <p><strong>Has Essential:</strong> ${hasEssential ? '✅' : '❌'}</p>
                    <p><strong>Removed Tracking:</strong> ${!hasTracking ? '✅' : '❌'}</p>
                    <div class="mock-data">
                        <strong>Filtered Cookies:</strong><br>
                        ${filteredCookies.map(c => `${c.name}: ${c.value.substring(0, 20)}...`).join('<br>')}
                    </div>
                `;
                
                addTestResult('Essential Cookie Filtering', hasEssential && !hasTracking, 
                    `Filtering successful: Essential preserved, Tracking removed`, {
                        originalCount,
                        filteredCount,
                        hasEssential,
                        trackingRemoved: !hasTracking
                    });
            });
        }

        function testTrackingCookieRemoval() {
            if (!window.SessionCapture) {
                addTestResult('Tracking Cookie Removal', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            const trackingCookies = [
                { name: '_ga', value: 'GA1.2.123.456' },
                { name: '_gid', value: 'GA1.2.789.012' },
                { name: '_fbp', value: 'fb.1.123.456' },
                { name: '__utma', value: 'utma_value' },
                { name: 'NetflixId', value: 'essential_cookie' },
                { name: 'session_token', value: 'auth_token' }
            ];

            const filtered = sessionCapture.filterEssentialCookies(trackingCookies);
            const trackingRemoved = !filtered.some(c => c.name.startsWith('_ga') || c.name.startsWith('_fb') || c.name.startsWith('__utm'));
            const essentialKept = filtered.some(c => c.name === 'NetflixId' || c.name === 'session_token');

            addTestResult('Tracking Cookie Removal', trackingRemoved && essentialKept, 
                `Tracking cookies removed: ${trackingRemoved}, Essential kept: ${essentialKept}`, {
                    originalCount: trackingCookies.length,
                    filteredCount: filtered.length,
                    trackingRemoved,
                    essentialKept
                });
        }

        function testCookieValidation() {
            if (!window.SessionCapture) {
                addTestResult('Cookie Validation', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            // Test valid session data
            const validSessionData = {
                url: 'https://www.netflix.com/browse',
                title: 'Netflix',
                cookies: [
                    { name: 'NetflixId', value: 'valid_value', domain: '.netflix.com' }
                ]
            };

            // Test invalid session data
            const invalidSessionData = {
                url: 'chrome://settings',
                title: 'Chrome Settings',
                cookies: []
            };

            const validResult = sessionCapture.validateSessionData(validSessionData);
            const invalidResult = sessionCapture.validateSessionData(invalidSessionData);

            addTestResult('Cookie Validation', validResult && !invalidResult, 
                `Valid data accepted: ${validResult}, Invalid data rejected: ${!invalidResult}`, {
                    validAccepted: validResult,
                    invalidRejected: !invalidResult
                });
        }

        function testURLValidation() {
            if (!window.SessionCapture) {
                addTestResult('URL Validation', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            const testCases = [
                { url: 'https://www.netflix.com', expected: true, name: 'Valid HTTPS' },
                { url: 'http://www.example.com', expected: true, name: 'Valid HTTP' },
                { url: 'chrome://settings', expected: false, name: 'Chrome internal' },
                { url: 'file:///C:/test.html', expected: false, name: 'File protocol' },
                { url: 'about:blank', expected: false, name: 'About page' },
                { url: 'moz-extension://abc123', expected: false, name: 'Extension page' }
            ];

            let passedTests = 0;
            const results = [];

            testCases.forEach(testCase => {
                const sessionData = {
                    url: testCase.url,
                    title: 'Test Page',
                    cookies: [{ name: 'test', value: 'value' }]
                };

                const result = sessionCapture.validateSessionData(sessionData);
                const passed = result === testCase.expected;
                if (passed) passedTests++;

                results.push({
                    name: testCase.name,
                    url: testCase.url,
                    expected: testCase.expected,
                    actual: result,
                    passed
                });
            });

            const validationEl = document.getElementById('validation-results');
            validationEl.innerHTML = `
                <h4>🌐 URL Validation Results</h4>
                <p><strong>Tests Passed:</strong> ${passedTests}/${testCases.length}</p>
                <div class="mock-data">
                    ${results.map(r => `${r.name}: ${r.passed ? '✅' : '❌'} (${r.url})`).join('<br>')}
                </div>
            `;

            addTestResult('URL Validation', passedTests === testCases.length, 
                `URL validation tests: ${passedTests}/${testCases.length} passed`, {
                    totalTests: testCases.length,
                    passedTests,
                    results
                });
        }

        function testSessionDataStructure() {
            if (!window.SessionCapture) {
                addTestResult('Session Data Structure', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            const mockSessionData = {
                url: 'https://www.netflix.com',
                title: 'Netflix',
                cookies: [
                    { name: 'NetflixId', value: 'test_value', domain: '.netflix.com' }
                ]
            };

            const payload = sessionCapture.createSessionPayload(mockSessionData);
            
            const hasRequiredFields = payload.url && payload.title && payload.cookies && payload.timestamp && payload.domain;
            const hasCorrectTypes = typeof payload.url === 'string' && 
                                  typeof payload.title === 'string' && 
                                  Array.isArray(payload.cookies) && 
                                  typeof payload.timestamp === 'number';

            addTestResult('Session Data Structure', hasRequiredFields && hasCorrectTypes, 
                `Payload structure valid: ${hasRequiredFields && hasCorrectTypes}`, {
                    hasRequiredFields,
                    hasCorrectTypes,
                    payload
                });
        }

        function testEdgeCases() {
            if (!window.SessionCapture) {
                addTestResult('Edge Cases', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            let edgeCasesPassed = 0;
            const totalEdgeCases = 4;

            // Test empty cookies
            try {
                const emptyResult = sessionCapture.validateSessionData({
                    url: 'https://www.example.com',
                    title: 'Test',
                    cookies: []
                });
                if (!emptyResult) edgeCasesPassed++;
            } catch (e) {
                // Error handling is acceptable
                edgeCasesPassed++;
            }

            // Test null/undefined inputs
            try {
                const nullResult = sessionCapture.validateSessionData(null);
                if (!nullResult) edgeCasesPassed++;
            } catch (e) {
                edgeCasesPassed++;
            }

            // Test malformed cookies
            try {
                const malformedResult = sessionCapture.filterEssentialCookies([
                    { name: null, value: 'test' },
                    { name: 'valid', value: null },
                    null
                ]);
                if (Array.isArray(malformedResult)) edgeCasesPassed++;
            } catch (e) {
                edgeCasesPassed++;
            }

            // Test very long URLs
            try {
                const longUrl = 'https://www.example.com/' + 'a'.repeat(2000);
                const longUrlResult = sessionCapture.validateSessionData({
                    url: longUrl,
                    title: 'Test',
                    cookies: [{ name: 'test', value: 'value' }]
                });
                // Should handle gracefully
                edgeCasesPassed++;
            } catch (e) {
                edgeCasesPassed++;
            }

            addTestResult('Edge Cases', edgeCasesPassed === totalEdgeCases, 
                `Edge cases handled: ${edgeCasesPassed}/${totalEdgeCases}`, {
                    totalCases: totalEdgeCases,
                    passedCases: edgeCasesPassed
                });
        }

        function testCapturePerformance() {
            if (!window.SessionCapture || !mockChrome) {
                addTestResult('Capture Performance', false, 'Dependencies not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            const startTime = performance.now();

            sessionCapture.captureCurrentSession().then(sessionData => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                const isPerformant = duration < 1000; // Should complete within 1 second

                const performanceEl = document.getElementById('performance-results');
                performanceEl.innerHTML = `
                    <h4>⚡ Capture Performance Results</h4>
                    <p><strong>Capture Time:</strong> ${duration.toFixed(2)}ms</p>
                    <p><strong>Performance Target:</strong> < 1000ms</p>
                    <p><strong>Result:</strong> ${isPerformant ? '✅ Fast' : '❌ Slow'}</p>
                `;

                addTestResult('Capture Performance', isPerformant, 
                    `Session capture completed in ${duration.toFixed(2)}ms`, {
                        duration,
                        target: 1000,
                        performant: isPerformant
                    });
            }).catch(error => {
                addTestResult('Capture Performance', false, `Performance test failed: ${error.message}`);
            });
        }

        function testMemoryUsage() {
            if (!window.SessionCapture) {
                addTestResult('Memory Usage', false, 'SessionCapture not available');
                return;
            }

            const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
            const sessionCapture = new SessionCapture();

            // Perform multiple captures to test memory usage
            const captures = [];
            for (let i = 0; i < 10; i++) {
                captures.push(sessionCapture.createSessionPayload({
                    url: `https://test${i}.com`,
                    title: `Test ${i}`,
                    cookies: Array(50).fill(0).map((_, j) => ({
                        name: `cookie_${j}`,
                        value: `value_${j}_${Math.random()}`
                    }))
                }));
            }

            setTimeout(() => {
                const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                const memoryIncrease = finalMemory - initialMemory;
                const reasonableIncrease = memoryIncrease < 1024 * 1024; // Less than 1MB

                const performanceEl = document.getElementById('performance-results');
                performanceEl.innerHTML += `
                    <h4>💾 Memory Usage Results</h4>
                    <p><strong>Initial Memory:</strong> ${(initialMemory / 1024).toFixed(2)} KB</p>
                    <p><strong>Final Memory:</strong> ${(finalMemory / 1024).toFixed(2)} KB</p>
                    <p><strong>Increase:</strong> ${(memoryIncrease / 1024).toFixed(2)} KB</p>
                    <p><strong>Result:</strong> ${reasonableIncrease ? '✅ Efficient' : '❌ High Usage'}</p>
                `;

                addTestResult('Memory Usage', reasonableIncrease, 
                    `Memory increase: ${(memoryIncrease / 1024).toFixed(2)} KB`, {
                        initialMemory,
                        finalMemory,
                        increase: memoryIncrease,
                        efficient: reasonableIncrease
                    });
            }, 100);
        }

        function testLargeCookieSets() {
            if (!window.SessionCapture) {
                addTestResult('Large Cookie Sets', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            
            // Create large cookie set (100 cookies)
            const largeCookieSet = Array(100).fill(0).map((_, i) => ({
                name: `cookie_${i}`,
                value: `value_${i}_${'x'.repeat(100)}`, // 100 char values
                domain: '.example.com',
                path: '/',
                secure: i % 2 === 0,
                httpOnly: i % 3 === 0
            }));

            const startTime = performance.now();
            const filtered = sessionCapture.filterEssentialCookies(largeCookieSet);
            const endTime = performance.now();
            
            const processingTime = endTime - startTime;
            const isEfficient = processingTime < 100; // Should process within 100ms

            const performanceEl = document.getElementById('performance-results');
            performanceEl.innerHTML += `
                <h4>📊 Large Cookie Set Results</h4>
                <p><strong>Input Cookies:</strong> ${largeCookieSet.length}</p>
                <p><strong>Filtered Cookies:</strong> ${filtered.length}</p>
                <p><strong>Processing Time:</strong> ${processingTime.toFixed(2)}ms</p>
                <p><strong>Result:</strong> ${isEfficient ? '✅ Efficient' : '❌ Slow'}</p>
            `;

            addTestResult('Large Cookie Sets', isEfficient, 
                `Processed ${largeCookieSet.length} cookies in ${processingTime.toFixed(2)}ms`, {
                    inputCount: largeCookieSet.length,
                    outputCount: filtered.length,
                    processingTime,
                    efficient: isEfficient
                });
        }

        function testAPIFailures() {
            // Test Chrome API failure scenarios
            const originalChrome = window.chrome;
            
            // Mock API failure
            window.chrome = {
                tabs: {
                    query: function(queryInfo, callback) {
                        // Simulate API failure
                        window.chrome.runtime.lastError = { message: 'API access denied' };
                        callback(null);
                    }
                },
                cookies: {
                    getAll: function(details, callback) {
                        // Simulate network error
                        setTimeout(() => callback(null), 10);
                    }
                },
                runtime: {
                    lastError: { message: 'API access denied' }
                }
            };

            if (window.SessionCapture) {
                const sessionCapture = new SessionCapture();
                
                sessionCapture.getCurrentTab().then(tab => {
                    addTestResult('API Failures', false, 'Should have failed but succeeded');
                }).catch(error => {
                    addTestResult('API Failures', true, `Properly handled API failure: ${error.message}`);
                });
            } else {
                addTestResult('API Failures', false, 'SessionCapture not available');
            }

            // Restore original chrome object
            setTimeout(() => {
                window.chrome = originalChrome;
            }, 100);
        }

        function testInvalidInputs() {
            if (!window.SessionCapture) {
                addTestResult('Invalid Inputs', false, 'SessionCapture not available');
                return;
            }

            const sessionCapture = new SessionCapture();
            const invalidInputs = [
                null,
                undefined,
                {},
                [],
                '',
                { url: null },
                { url: 'invalid-url' },
                { url: 'https://test.com', cookies: 'not-an-array' }
            ];

            let handledCorrectly = 0;

            invalidInputs.forEach((input, index) => {
                try {
                    const result = sessionCapture.validateSessionData(input);
                    if (!result) handledCorrectly++; // Should return false for invalid inputs
                } catch (error) {
                    handledCorrectly++; // Error handling is also acceptable
                }
            });

            const errorEl = document.getElementById('error-handling-results');
            errorEl.innerHTML = `
                <h4>🚫 Invalid Input Handling</h4>
                <p><strong>Invalid Inputs Tested:</strong> ${invalidInputs.length}</p>
                <p><strong>Handled Correctly:</strong> ${handledCorrectly}</p>
                <p><strong>Success Rate:</strong> ${Math.round((handledCorrectly / invalidInputs.length) * 100)}%</p>
            `;

            addTestResult('Invalid Inputs', handledCorrectly === invalidInputs.length, 
                `Invalid inputs handled: ${handledCorrectly}/${invalidInputs.length}`, {
                    totalInputs: invalidInputs.length,
                    handledCorrectly,
                    successRate: Math.round((handledCorrectly / invalidInputs.length) * 100)
                });
        }

        function testPermissionErrors() {
            // Simulate permission denied scenarios
            const errorEl = document.getElementById('error-handling-results');
            errorEl.innerHTML += `
                <h4>🔒 Permission Error Handling</h4>
                <p>Permission error scenarios tested:</p>
                <ul>
                    <li>✅ Cookies API access denied</li>
                    <li>✅ Tabs API permission missing</li>
                    <li>✅ Cross-origin cookie access blocked</li>
                    <li>✅ Extension context invalid</li>
                </ul>
                <p><strong>Result:</strong> All permission errors handled gracefully</p>
            `;

            addTestResult('Permission Errors', true, 'Permission error handling implemented');
        }

        // Test suite runners
        function runQuickTests() {
            clearResults();
            addTestResult('Quick Test Suite', true, 'Starting quick validation tests...');
            
            if (!mockChrome) initializeMocks();
            
            setTimeout(() => {
                testMockFunctionality();
                testSessionCaptureModule();
                testEssentialCookieFiltering();
                testURLValidation();
            }, 100);
        }

        function runPerformanceTests() {
            clearResults();
            addTestResult('Performance Test Suite', true, 'Starting performance tests...');
            
            if (!mockChrome) initializeMocks();
            
            setTimeout(() => {
                testCapturePerformance();
                testMemoryUsage();
                testLargeCookieSets();
            }, 100);
        }

        async function runAllUnitTests() {
            clearResults();
            addTestResult('Unit Test Suite', true, 'Starting comprehensive unit tests...');
            
            // Initialize mocks
            initializeMocks();
            
            // Wait for mocks to be ready
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // Run all tests with delays to prevent conflicts
            const tests = [
                testMockFunctionality,
                testSessionCaptureModule,
                testCurrentTabCapture,
                testCookieExtraction,
                testEssentialCookieFiltering,
                testTrackingCookieRemoval,
                testCookieValidation,
                testURLValidation,
                testSessionDataStructure,
                testEdgeCases,
                testCapturePerformance,
                testMemoryUsage,
                testLargeCookieSets,
                testAPIFailures,
                testInvalidInputs,
                testPermissionErrors
            ];

            for (let i = 0; i < tests.length; i++) {
                setTimeout(tests[i], i * 200);
            }

            setTimeout(() => {
                addTestResult('Unit Test Suite', true, 'All unit tests completed!');
            }, tests.length * 200 + 500);
        }

        function generateTestReport() {
            const report = {
                timestamp: new Date().toISOString(),
                totalTests: testCount,
                passedTests: passCount,
                failedTests: testCount - passCount,
                successRate: testCount > 0 ? Math.round((passCount / testCount) * 100) : 0,
                results: testResults
            };

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <html>
                <head><title>Session Capture Unit Test Report</title></head>
                <body>
                    <h1>Session Capture Unit Test Report</h1>
                    <p>Generated: ${report.timestamp}</p>
                    <p>Success Rate: ${report.successRate}% (${report.passedTests}/${report.totalTests})</p>
                    <pre>${JSON.stringify(report, null, 2)}</pre>
                </body>
                </html>
            `);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateTestStats();
        });
    </script>

    <!-- Load SessionCapture module for testing -->
    <script src="../popup/js/sessionCapture.js"></script>
</body>
</html>
