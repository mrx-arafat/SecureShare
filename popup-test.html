<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Popup Test - Exact Extension Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            width: 400px;
            height: 600px;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            overflow-y: auto;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            color: #d94343;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }
        .btn {
            background: #d94343;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
        }
        .btn:hover { background: #c13333; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .qr-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        canvas {
            border: 2px solid #d94343;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .module-status {
            font-size: 11px;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .module-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        .loaded { color: #28a745; }
        .missing { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">üîß Popup Test</div>
        
        <div id="status" class="status info">
            üîÑ Initializing extension simulation...
        </div>

        <div class="module-status" id="module-status">
            <strong>Module Status:</strong>
            <div id="module-list">Loading...</div>
        </div>

        <button id="js-generate-qr-share" class="btn">
            üîÑ Generate QR Code
        </button>

        <div class="qr-section" id="qr-section" style="display: none;">
            <h4>Generated QR Code</h4>
            <canvas id="js-qr-canvas-share" width="200" height="200"></canvas>
            <div id="qr-info" style="font-size: 12px; margin-top: 10px;"></div>
        </div>

        <div class="log" id="test-log">üîß Popup test log...</div>
    </div>

    <!-- Load modules in EXACT same order as extension popup -->
    <script src="popup/js/vendor/qrious.min.js"></script>
    <script src="popup/js/vendor/sjcl.min.js"></script>
    <script src="popup/js/vendor/_t.min.js"></script>
    <script src="popup/js/vendor/base64.min.js"></script>
    <script src="popup/js/vendor/rawdeflate.min.js"></script>

    <!-- Core Modules -->
    <script src="popup/js/log.js"></script>
    <script src="popup/js/configuration.js"></script>
    <script src="popup/js/http.js"></script>
    <script src="popup/js/analytics.js"></script>
    <script src="popup/js/cryptography.js"></script>
    <script src="popup/js/cookieManager.js"></script>
    <script src="popup/js/shareText.js"></script>

    <!-- Advanced QR Mobile Flow Modules -->
    <script src="popup/js/base64url.js"></script>
    <script src="popup/js/payloadManager.js"></script>
    <script src="popup/js/mobileFlow.js"></script>
    <script src="popup/js/qrShareDirect.js"></script>
    
    <script>
        let testLog = '';
        let currentQRUrl = '';

        function log(message) {
            testLog += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('test-log').textContent = testLog;
            console.log('POPUP-TEST:', message);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function checkModules() {
            const modules = {
                'QRious': typeof QRious !== 'undefined',
                'sjcl': typeof sjcl !== 'undefined',
                'RawDeflate': typeof RawDeflate !== 'undefined',
                'window.log': typeof window.log !== 'undefined',
                'window.base64url': typeof window.base64url !== 'undefined',
                'window.payloadManager': typeof window.payloadManager !== 'undefined',
                'window.mobileFlow': typeof window.mobileFlow !== 'undefined',
                'window.qrShareDirect': typeof window.qrShareDirect !== 'undefined'
            };

            const moduleList = document.getElementById('module-list');
            const loadedCount = Object.values(modules).filter(Boolean).length;
            const totalCount = Object.keys(modules).length;

            moduleList.innerHTML = Object.entries(modules).map(([name, loaded]) => 
                `<div class="module-item">
                    <span>${name}</span>
                    <span class="${loaded ? 'loaded' : 'missing'}">${loaded ? '‚úÖ' : '‚ùå'}</span>
                </div>`
            ).join('');

            log(`Module check: ${loadedCount}/${totalCount} modules loaded`);
            
            if (loadedCount === totalCount) {
                updateStatus(`‚úÖ All modules loaded (${loadedCount}/${totalCount})`, 'success');
                return true;
            } else {
                const missing = Object.entries(modules).filter(([k,v]) => !v).map(([k]) => k);
                log('Missing modules: ' + missing.join(', '));
                updateStatus(`‚ùå Missing modules: ${missing.length}`, 'error');
                return false;
            }
        }

        // Simulate the exact QR generation flow from main.js
        async function simulateQRGeneration() {
            try {
                log('üöÄ Starting QR generation simulation...');
                
                const button = document.getElementById('js-generate-qr-share');
                button.disabled = true;
                button.textContent = '‚è≥ Generating...';

                // Check if qrShareDirect is available (exact same check as main.js)
                if (window.qrShareDirect) {
                    log('‚úÖ qrShareDirect module is available');

                    // Create mock session data (simulating what extension would get)
                    const sessionData = {
                        cookies: [
                            { name: 'session_test', value: 'popup_test_123', domain: 'github.com', path: '/' },
                            { name: 'auth_token', value: 'token_456', domain: 'github.com', path: '/' }
                        ],
                        url: 'https://github.com/mrx-arafat',
                        title: 'Popup Test Session',
                        timestamp: Date.now()
                    };

                    log('üìä Created mock session data');

                    // Show QR section
                    document.getElementById('qr-section').style.display = 'block';

                    // Generate QR code (exact same call as main.js)
                    const loginUrl = await window.qrShareDirect.generateDirectLoginQR(sessionData, 'js-qr-canvas-share');
                    
                    log('‚úÖ QR generation successful!');
                    log('üìè Generated URL length: ' + loginUrl.length);
                    
                    currentQRUrl = loginUrl;

                    // Update info
                    document.getElementById('qr-info').innerHTML = `
                        <strong>‚úÖ QR Generated!</strong><br>
                        Length: ${loginUrl.length} chars<br>
                        Type: ${loginUrl.startsWith('secureshare://') ? 'Deep Link' : 
                               loginUrl.startsWith('data:') ? 'Data URL' : 'Other'}<br>
                        <button onclick="window.open('${loginUrl}', '_blank')" style="margin-top: 5px; padding: 3px 8px; font-size: 11px;">Test QR</button>
                    `;

                    updateStatus('‚úÖ QR code generated successfully!', 'success');

                } else {
                    throw new Error('QR Share module not loaded');
                }

            } catch (error) {
                log('‚ùå QR generation failed: ' + error.message);
                updateStatus('‚ùå QR generation failed: ' + error.message, 'error');
                console.error('QR generation error:', error);
            } finally {
                const button = document.getElementById('js-generate-qr-share');
                button.disabled = false;
                button.textContent = 'üîÑ Generate QR Code';
            }
        }

        // Set up event listener (exact same as main.js)
        document.getElementById('js-generate-qr-share').addEventListener('click', simulateQRGeneration);

        // Initialize on page load
        window.addEventListener('load', function() {
            log('üîß Popup test page loaded');
            
            // Check modules after a short delay to ensure all scripts loaded
            setTimeout(() => {
                const allLoaded = checkModules();
                
                if (allLoaded) {
                    updateStatus('‚úÖ Ready to generate QR code!', 'success');
                    log('üéâ All modules loaded successfully - ready for QR generation');
                } else {
                    updateStatus('‚ùå Some modules failed to load', 'error');
                    log('‚ùå Module loading incomplete - QR generation may fail');
                }
            }, 500);
        });

        // Log any script errors
        window.addEventListener('error', function(event) {
            log(`üí• Script error: ${event.message} at ${event.filename}:${event.lineno}`);
            updateStatus('üí• Script error detected - check console', 'error');
        });
    </script>
</body>
</html>
