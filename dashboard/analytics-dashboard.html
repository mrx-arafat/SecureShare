<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureShare Analytics Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #333;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        .dashboard-header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .dashboard-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }
        .metric-card h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.2em;
        }
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        .success-rate {
            color: #28a745;
        }
        .warning-rate {
            color: #ffc107;
        }
        .error-rate {
            color: #dc3545;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .chart-container h3 {
            margin: 0 0 20px 0;
            color: #667eea;
        }
        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
        .website-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .website-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        .website-item:last-child {
            border-bottom: none;
        }
        .website-name {
            font-weight: 500;
        }
        .website-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .alert-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .alert-section h3 {
            color: #856404;
            margin: 0 0 15px 0;
        }
        .alert-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ffc107;
        }
        .controls {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .controls button:hover {
            background: #5a6fd8;
        }
        .controls button.danger {
            background: #dc3545;
        }
        .controls button.danger:hover {
            background: #c82333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-online {
            background: #28a745;
        }
        .status-warning {
            background: #ffc107;
        }
        .status-offline {
            background: #dc3545;
        }
        .refresh-time {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>üîê SecureShare Analytics Dashboard</h1>
        <p>Real-time monitoring and analytics for session sharing performance</p>
        <p><span class="status-indicator status-online"></span>System Status: Online</p>
    </div>

    <div class="controls">
        <h3>Dashboard Controls</h3>
        <button onclick="refreshDashboard()">üîÑ Refresh Data</button>
        <button onclick="exportMetrics()">üìä Export Metrics</button>
        <button onclick="toggleAnalytics()">‚öôÔ∏è Toggle Analytics</button>
        <button onclick="clearAllData()" class="danger">üóëÔ∏è Clear All Data</button>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <h3>QR Generation Success Rate</h3>
            <div class="metric-value success-rate" id="qr-success-rate">--</div>
            <div class="metric-label">Successful QR generations</div>
        </div>
        <div class="metric-card">
            <h3>Mobile Processing Success Rate</h3>
            <div class="metric-value success-rate" id="mobile-success-rate">--</div>
            <div class="metric-label">Successful mobile sessions</div>
        </div>
        <div class="metric-card">
            <h3>Average Session Transfer Time</h3>
            <div class="metric-value" id="avg-transfer-time">--</div>
            <div class="metric-label">End-to-end transfer time</div>
        </div>
        <div class="metric-card">
            <h3>Total Sessions Shared</h3>
            <div class="metric-value" id="total-sessions">--</div>
            <div class="metric-label">All-time session transfers</div>
        </div>
        <div class="metric-card">
            <h3>Error Recovery Rate</h3>
            <div class="metric-value warning-rate" id="error-recovery-rate">--</div>
            <div class="metric-label">Successful error recoveries</div>
        </div>
        <div class="metric-card">
            <h3>Security Events</h3>
            <div class="metric-value error-rate" id="security-events">--</div>
            <div class="metric-label">Suspicious activities detected</div>
        </div>
    </div>

    <div class="chart-container">
        <h3>üìà Performance Trends</h3>
        <div class="chart-placeholder">
            Performance charts will be displayed here<br>
            (Integration with Chart.js or similar library)
        </div>
    </div>

    <div class="website-list">
        <h3>üåê Most Shared Websites</h3>
        <div id="top-websites">
            <div class="website-item">
                <span class="website-name">Loading...</span>
                <span class="website-count">--</span>
            </div>
        </div>
    </div>

    <div class="alert-section" id="alerts-section" style="display: none;">
        <h3>‚ö†Ô∏è Recent Alerts</h3>
        <div id="recent-alerts">
            <!-- Alerts will be populated here -->
        </div>
    </div>

    <div class="chart-container">
        <h3>üìä System Health</h3>
        <div class="metrics-grid">
            <div class="metric-card">
                <h3>API Response Time</h3>
                <div class="metric-value" id="api-response-time">--</div>
                <div class="metric-label">Average response time (ms)</div>
            </div>
            <div class="metric-card">
                <h3>QR Generation Time</h3>
                <div class="metric-value" id="qr-generation-time">--</div>
                <div class="metric-label">Average generation time (ms)</div>
            </div>
            <div class="metric-card">
                <h3>Mobile Load Time</h3>
                <div class="metric-value" id="mobile-load-time">--</div>
                <div class="metric-label">Average mobile processing (ms)</div>
            </div>
            <div class="metric-card">
                <h3>Error Count</h3>
                <div class="metric-value error-rate" id="error-count">--</div>
                <div class="metric-label">Total errors logged</div>
            </div>
        </div>
    </div>

    <div class="refresh-time">
        Last updated: <span id="last-updated">--</span>
    </div>

    <script>
        let analyticsInstance = null;
        let refreshInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            startAutoRefresh();
        });

        async function initializeDashboard() {
            try {
                // Try to get analytics from extension context
                if (typeof chrome !== 'undefined' && chrome.storage) {
                    await loadAnalyticsFromStorage();
                } else {
                    // Fallback to mock data for demonstration
                    loadMockData();
                }
                
                updateDashboard();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                loadMockData();
                updateDashboard();
            }
        }

        async function loadAnalyticsFromStorage() {
            try {
                const stored = await chrome.storage.local.get(['analytics_metrics', 'analytics_recent_events']);
                
                if (stored.analytics_metrics) {
                    analyticsInstance = {
                        metrics: stored.analytics_metrics,
                        recentEvents: stored.analytics_recent_events || []
                    };
                } else {
                    loadMockData();
                }
            } catch (error) {
                console.warn('Could not load from storage:', error);
                loadMockData();
            }
        }

        function loadMockData() {
            // Mock data for demonstration
            analyticsInstance = {
                metrics: {
                    qrGeneration: { attempts: 150, successes: 142, failures: 8, avgTime: 850, totalTime: 120700 },
                    mobileProcessing: { attempts: 142, successes: 135, failures: 7, avgTime: 1200, totalTime: 162000 },
                    sessionTransfer: { attempts: 135, successes: 128, avgTime: 2500, totalTime: 320000 },
                    errors: { 'qr_generation_network_error': 5, 'mobile_processing_timeout': 3 },
                    performance: { 
                        apiResponseTimes: [
                            { endpoint: '/api/sessions', duration: 245, timestamp: Date.now() },
                            { endpoint: '/api/sessions/[id]', duration: 180, timestamp: Date.now() }
                        ],
                        qrGenerationTimes: [850, 920, 780, 1100, 650],
                        mobileLoadTimes: [1200, 1350, 980, 1450, 1100]
                    },
                    security: { suspiciousActivities: 2, failedDecryptions: 1, expiredLinkAccess: 5, rapidGenerations: 3 },
                    userExperience: { 
                        commonWebsites: { 'netflix.com': 45, 'youtube.com': 32, 'amazon.com': 28, 'facebook.com': 15 },
                        errorRecoveries: 12,
                        abandonedSessions: 8
                    }
                },
                recentEvents: [
                    { eventType: 'qr_generation_success', data: { duration: 850, domain: 'netflix.com' }, timestamp: Date.now() - 300000 },
                    { eventType: 'mobile_processing_success', data: { duration: 1200 }, timestamp: Date.now() - 600000 }
                ]
            };
        }

        function updateDashboard() {
            if (!analyticsInstance) return;

            const metrics = analyticsInstance.metrics;

            // Update success rates
            const qrSuccessRate = calculateSuccessRate(metrics.qrGeneration.successes, metrics.qrGeneration.attempts);
            const mobileSuccessRate = calculateSuccessRate(metrics.mobileProcessing.successes, metrics.mobileProcessing.attempts);
            
            document.getElementById('qr-success-rate').textContent = qrSuccessRate + '%';
            document.getElementById('mobile-success-rate').textContent = mobileSuccessRate + '%';

            // Update performance metrics
            document.getElementById('avg-transfer-time').textContent = Math.round(metrics.sessionTransfer.avgTime) + 'ms';
            document.getElementById('total-sessions').textContent = metrics.sessionTransfer.successes;

            // Update error recovery rate
            const totalErrors = Object.values(metrics.errors).reduce((sum, count) => sum + count, 0);
            const recoveryRate = totalErrors > 0 ? Math.round((metrics.userExperience.errorRecoveries / totalErrors) * 100) : 100;
            document.getElementById('error-recovery-rate').textContent = recoveryRate + '%';

            // Update security events
            const totalSecurityEvents = Object.values(metrics.security).reduce((sum, count) => sum + count, 0);
            document.getElementById('security-events').textContent = totalSecurityEvents;

            // Update performance details
            const avgApiTime = calculateAverageAPIResponseTime(metrics.performance.apiResponseTimes);
            document.getElementById('api-response-time').textContent = avgApiTime + 'ms';
            document.getElementById('qr-generation-time').textContent = Math.round(metrics.qrGeneration.avgTime) + 'ms';
            document.getElementById('mobile-load-time').textContent = Math.round(metrics.mobileProcessing.avgTime) + 'ms';
            document.getElementById('error-count').textContent = Object.keys(metrics.errors).length;

            // Update top websites
            updateTopWebsites(metrics.userExperience.commonWebsites);

            // Update last refresh time
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
        }

        function calculateSuccessRate(successes, attempts) {
            return attempts > 0 ? Math.round((successes / attempts) * 100) : 0;
        }

        function calculateAverageAPIResponseTime(apiTimes) {
            if (!apiTimes || apiTimes.length === 0) return 0;
            const total = apiTimes.reduce((sum, item) => sum + item.duration, 0);
            return Math.round(total / apiTimes.length);
        }

        function updateTopWebsites(websites) {
            const container = document.getElementById('top-websites');
            container.innerHTML = '';

            const sortedWebsites = Object.entries(websites)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            if (sortedWebsites.length === 0) {
                container.innerHTML = '<div class="website-item"><span class="website-name">No data available</span><span class="website-count">0</span></div>';
                return;
            }

            sortedWebsites.forEach(([domain, count]) => {
                const item = document.createElement('div');
                item.className = 'website-item';
                item.innerHTML = `
                    <span class="website-name">${domain}</span>
                    <span class="website-count">${count}</span>
                `;
                container.appendChild(item);
            });
        }

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                refreshDashboard();
            }, 30000); // Refresh every 30 seconds
        }

        async function refreshDashboard() {
            await initializeDashboard();
            console.log('Dashboard refreshed');
        }

        async function exportMetrics() {
            if (!analyticsInstance) {
                alert('No analytics data available to export');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                metrics: analyticsInstance.metrics,
                summary: {
                    qrSuccessRate: calculateSuccessRate(analyticsInstance.metrics.qrGeneration.successes, analyticsInstance.metrics.qrGeneration.attempts),
                    mobileSuccessRate: calculateSuccessRate(analyticsInstance.metrics.mobileProcessing.successes, analyticsInstance.metrics.mobileProcessing.attempts),
                    avgTransferTime: analyticsInstance.metrics.sessionTransfer.avgTime,
                    totalSessions: analyticsInstance.metrics.sessionTransfer.successes
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `secureshare-analytics-${Date.now()}.json`;
            link.click();
        }

        async function toggleAnalytics() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                try {
                    const stored = await chrome.storage.local.get(['analytics_enabled']);
                    const isEnabled = stored.analytics_enabled !== false; // Default to true
                    
                    await chrome.storage.local.set({ analytics_enabled: !isEnabled });
                    alert(`Analytics ${!isEnabled ? 'enabled' : 'disabled'}`);
                } catch (error) {
                    alert('Could not toggle analytics: ' + error.message);
                }
            } else {
                alert('Analytics toggle not available in this context');
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all analytics data? This action cannot be undone.')) {
                return;
            }

            if (typeof chrome !== 'undefined' && chrome.storage) {
                try {
                    await chrome.storage.local.remove(['analytics_metrics', 'analytics_recent_events']);
                    alert('All analytics data cleared');
                    await refreshDashboard();
                } catch (error) {
                    alert('Could not clear data: ' + error.message);
                }
            } else {
                alert('Data clearing not available in this context');
            }
        }
    </script>
</body>
</html>
