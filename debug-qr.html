<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç QR Debug - Module Loading Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .title {
            color: #d94343;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .module {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
        }
        .module.loaded { background: #d4edda; color: #155724; }
        .module.missing { background: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .btn {
            background: #d94343;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px;
        }
        .btn:hover { background: #c13333; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        canvas {
            border: 2px solid #d94343;
            border-radius: 10px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">üîç QR Debug - Module Loading Test</div>
        
        <div id="overall-status" class="status info">
            üîÑ Checking module loading status...
        </div>

        <div class="module-grid" id="module-grid">
            <!-- Module status will be populated here -->
        </div>

        <button class="btn" onclick="runDebugTest()">üîç Run Debug Test</button>
        <button class="btn" onclick="testQRGeneration()">üé® Test QR Generation</button>
        <button class="btn" onclick="checkExtensionContext()">üîß Check Extension Context</button>

        <div class="test-section">
            <h3>üé® QR Generation Test</h3>
            <canvas id="debug-qr" width="200" height="200" style="display: none;"></canvas>
            <div id="qr-result" style="margin-top: 10px;"></div>
        </div>

        <div class="log" id="debug-log">üîç Debug log will appear here...</div>
    </div>

    <!-- Load modules in exact same order as extension -->
    <script src="popup/js/vendor/qrious.min.js"></script>
    <script src="popup/js/vendor/sjcl.min.js"></script>
    <script src="popup/js/vendor/rawdeflate.min.js"></script>
    <script src="popup/js/log.js"></script>
    <script src="popup/js/base64url.js"></script>
    <script src="popup/js/payloadManager.js"></script>
    <script src="popup/js/mobileFlow.js"></script>
    <script src="popup/js/qrShareDirect.js"></script>
    
    <script>
        let debugLog = '';

        function log(message) {
            debugLog += new Date().toLocaleTimeString() + ': ' + message + '\n';
            document.getElementById('debug-log').textContent = debugLog;
            console.log('DEBUG:', message);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('overall-status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function checkAllModules() {
            const modules = {
                'QRious': {
                    check: () => typeof QRious !== 'undefined',
                    details: () => QRious ? `Version: ${QRious.prototype.constructor.name}` : 'Not loaded'
                },
                'SJCL': {
                    check: () => typeof sjcl !== 'undefined',
                    details: () => sjcl ? 'Crypto library loaded' : 'Not loaded'
                },
                'RawDeflate': {
                    check: () => typeof RawDeflate !== 'undefined',
                    details: () => RawDeflate ? 'Compression library loaded' : 'Not loaded'
                },
                'window.log': {
                    check: () => typeof window.log !== 'undefined',
                    details: () => window.log ? 'Logging utility loaded' : 'Not loaded'
                },
                'window.base64url': {
                    check: () => typeof window.base64url !== 'undefined',
                    details: () => window.base64url ? 'Base64URL utility loaded' : 'Not loaded'
                },
                'window.payloadManager': {
                    check: () => typeof window.payloadManager !== 'undefined',
                    details: () => window.payloadManager ? 'Payload manager loaded' : 'Not loaded'
                },
                'window.mobileFlow': {
                    check: () => typeof window.mobileFlow !== 'undefined',
                    details: () => window.mobileFlow ? 'Mobile flow manager loaded' : 'Not loaded'
                },
                'window.qrShareDirect': {
                    check: () => typeof window.qrShareDirect !== 'undefined',
                    details: () => window.qrShareDirect ? 'QR Share Direct loaded' : 'Not loaded'
                }
            };

            const moduleGrid = document.getElementById('module-grid');
            let loadedCount = 0;
            let totalCount = Object.keys(modules).length;

            moduleGrid.innerHTML = Object.entries(modules).map(([name, config]) => {
                const isLoaded = config.check();
                if (isLoaded) loadedCount++;
                
                log(`${name}: ${isLoaded ? 'LOADED' : 'MISSING'} - ${config.details()}`);
                
                return `
                    <div class="module ${isLoaded ? 'loaded' : 'missing'}">
                        <div>${isLoaded ? '‚úÖ' : '‚ùå'} ${name}</div>
                        <small>${config.details()}</small>
                    </div>
                `;
            }).join('');

            log(`Module check complete: ${loadedCount}/${totalCount} modules loaded`);
            
            if (loadedCount === totalCount) {
                updateStatus(`‚úÖ All ${totalCount} modules loaded successfully!`, 'success');
                return true;
            } else {
                updateStatus(`‚ùå Only ${loadedCount}/${totalCount} modules loaded`, 'error');
                return false;
            }
        }

        function runDebugTest() {
            try {
                log('üîç Starting comprehensive debug test...');
                
                // Check all modules
                const allLoaded = checkAllModules();
                
                if (!allLoaded) {
                    log('‚ùå Cannot proceed - some modules are missing');
                    return;
                }

                // Test individual module functions
                log('üß™ Testing individual module functions...');
                
                // Test base64url
                try {
                    const testString = 'Hello World';
                    const encoded = window.base64url.encode(testString);
                    const decoded = window.base64url.decode(encoded);
                    log(`‚úÖ base64url test: "${testString}" -> "${encoded}" -> "${decoded}"`);
                } catch (error) {
                    log(`‚ùå base64url test failed: ${error.message}`);
                }

                // Test QRious
                try {
                    const testCanvas = document.createElement('canvas');
                    testCanvas.width = 100;
                    testCanvas.height = 100;
                    const qr = new QRious({
                        element: testCanvas,
                        value: 'test',
                        size: 100
                    });
                    log('‚úÖ QRious test: QR code generated successfully');
                } catch (error) {
                    log(`‚ùå QRious test failed: ${error.message}`);
                }

                // Test qrShareDirect methods
                try {
                    if (window.qrShareDirect && typeof window.qrShareDirect.validateSessionData === 'function') {
                        log('‚úÖ qrShareDirect methods are accessible');
                    } else {
                        log('‚ùå qrShareDirect methods not accessible');
                    }
                } catch (error) {
                    log(`‚ùå qrShareDirect test failed: ${error.message}`);
                }

                log('üéâ Debug test completed!');
                updateStatus('üéâ Debug test completed - check log for details', 'success');

            } catch (error) {
                log('üí• Debug test failed: ' + error.message);
                updateStatus('üí• Debug test failed: ' + error.message, 'error');
                console.error('Debug test error:', error);
            }
        }

        async function testQRGeneration() {
            try {
                log('üé® Testing QR generation...');
                
                if (!window.qrShareDirect) {
                    throw new Error('qrShareDirect module not available');
                }

                // Create test session data
                const sessionData = {
                    cookies: [
                        { name: 'debug_test', value: 'test_123', domain: 'example.com', path: '/' }
                    ],
                    url: 'https://example.com',
                    title: 'Debug Test Session',
                    timestamp: Date.now()
                };

                log('üìä Created test session data');

                // Show canvas
                const canvas = document.getElementById('debug-qr');
                canvas.style.display = 'block';

                // Generate QR
                const qrUrl = await window.qrShareDirect.generateDirectLoginQR(sessionData, 'debug-qr');
                
                log('‚úÖ QR generation successful!');
                log('üìè QR URL length: ' + qrUrl.length);
                log('üîó QR URL type: ' + (qrUrl.startsWith('secureshare://') ? 'Deep Link' : 
                                          qrUrl.startsWith('data:') ? 'Data URL' : 'Other'));

                document.getElementById('qr-result').innerHTML = `
                    <strong>‚úÖ QR Generated!</strong><br>
                    Length: ${qrUrl.length} chars<br>
                    Type: ${qrUrl.startsWith('secureshare://') ? 'Deep Link' : 
                           qrUrl.startsWith('data:') ? 'Data URL' : 'Other'}<br>
                    <button onclick="window.open('${qrUrl}', '_blank')" style="margin-top: 10px; padding: 5px 10px;">Test QR Content</button>
                `;

                updateStatus('‚úÖ QR generation test passed!', 'success');

            } catch (error) {
                log('‚ùå QR generation test failed: ' + error.message);
                updateStatus('‚ùå QR generation failed: ' + error.message, 'error');
                console.error('QR generation error:', error);
            }
        }

        function checkExtensionContext() {
            try {
                log('üîß Checking extension context...');
                
                // Check if we're in extension context
                const isExtension = typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id;
                log(`Extension context: ${isExtension ? 'YES' : 'NO'}`);
                
                if (isExtension) {
                    log(`Extension ID: ${chrome.runtime.id}`);
                    log('Chrome APIs available: ' + Object.keys(chrome).join(', '));
                } else {
                    log('Running in regular web page context');
                }

                // Check current URL
                log(`Current URL: ${window.location.href}`);
                log(`Protocol: ${window.location.protocol}`);
                log(`Host: ${window.location.host}`);

                updateStatus(`Context check complete - ${isExtension ? 'Extension' : 'Web page'} context`, 'info');

            } catch (error) {
                log('‚ùå Extension context check failed: ' + error.message);
                updateStatus('‚ùå Context check failed: ' + error.message, 'error');
            }
        }

        // Auto-run on page load
        window.addEventListener('load', function() {
            log('üîç Debug page loaded');
            updateStatus('üîç Debug page loaded - checking modules...', 'info');
            
            // Auto-run debug test after modules load
            setTimeout(() => {
                runDebugTest();
            }, 1000);
        });

        // Log any script errors
        window.addEventListener('error', function(event) {
            log(`üí• Script error: ${event.message} at ${event.filename}:${event.lineno}`);
        });
    </script>
</body>
</html>
