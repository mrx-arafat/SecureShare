<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #d94343;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
        }
        .test-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
        }
        .qr-container {
            text-align: center;
            margin: 20px 0;
        }
        canvas {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin: 10px;
        }
        .btn {
            background: linear-gradient(135deg, #d94343 0%, #c13333 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(217, 67, 67, 0.3);
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .url-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 15px 0;
            border: 1px solid #dee2e6;
            max-height: 150px;
            overflow-y: auto;
        }
        .explanation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">üîê SecureShare QR Code Fix Test</div>
        
        <div class="explanation">
            <strong>The Problem:</strong> The original QR codes generated data URLs that couldn't set cookies for other domains due to browser security restrictions. This test shows the new working solution.
        </div>

        <div class="test-section">
            <div class="test-title">‚úÖ New Working QR Code (Mobile-Friendly)</div>
            <div class="qr-container">
                <canvas id="working-qr" width="200" height="200"></canvas>
                <div id="working-status" class="status" style="display: none;"></div>
                <div id="working-url" class="url-display" style="display: none;"></div>
            </div>
            <button class="btn" onclick="generateWorkingQR()">Generate Working QR Code</button>
            <button class="btn" onclick="testWorkingURL()">Test Mobile URL</button>
        </div>

        <div class="test-section">
            <div class="test-title">‚ùå Old Broken QR Code (For Comparison)</div>
            <div class="qr-container">
                <canvas id="broken-qr" width="200" height="200"></canvas>
                <div id="broken-status" class="status" style="display: none;"></div>
                <div id="broken-url" class="url-display" style="display: none;"></div>
            </div>
            <button class="btn" onclick="generateBrokenQR()">Generate Old (Broken) QR Code</button>
            <button class="btn" onclick="testBrokenURL()">Test Broken URL</button>
        </div>

        <div class="explanation">
            <strong>How the Fix Works:</strong><br>
            ‚Ä¢ Instead of data URLs, we now generate URLs to a hosted mobile login page<br>
            ‚Ä¢ The mobile page provides session data that users can copy and paste into the SecureShare extension<br>
            ‚Ä¢ This works across all devices and browsers without security restrictions<br>
            ‚Ä¢ Users get clear instructions on how to apply the session on their mobile device
        </div>
    </div>

    <!-- Include QRious library -->
    <script src="popup/js/vendor/qrious.min.js"></script>
    
    <script>
        // Mock session data for testing
        const mockSessionData = {
            cookies: [
                { name: 'session_id', value: 'abc123', domain: 'example.com', path: '/' },
                { name: 'user_token', value: 'xyz789', domain: 'example.com', path: '/' }
            ],
            url: 'https://example.com/dashboard',
            title: 'Example Dashboard',
            timestamp: Date.now()
        };

        function generateWorkingQR() {
            try {
                // Simulate the new working method
                const encryptedData = btoa(JSON.stringify(mockSessionData));
                const shareData = {
                    type: 'qr_session',
                    sessionData: encryptedData,
                    targetUrl: mockSessionData.url,
                    title: mockSessionData.title,
                    timestamp: Date.now()
                };
                
                const encodedData = btoa(JSON.stringify(shareData));
                const mobileLoginUrl = `https://mrx-arafat.github.io/SecureShare/mobile-login.html?data=${encodedData}`;
                
                // Generate QR code
                const canvas = document.getElementById('working-qr');
                const qr = new QRious({
                    element: canvas,
                    value: mobileLoginUrl,
                    size: 200,
                    level: 'M',
                    background: '#ffffff',
                    foreground: '#000000'
                });

                showStatus('working-status', '‚úÖ Working QR code generated! This will open a mobile-friendly page.', 'success');
                showURL('working-url', mobileLoginUrl);
                
            } catch (error) {
                showStatus('working-status', '‚ùå Error: ' + error.message, 'error');
            }
        }

        function generateBrokenQR() {
            try {
                // Simulate the old broken method
                const encryptedData = btoa(JSON.stringify(mockSessionData));
                const brokenDataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(`
                    <!DOCTYPE html>
                    <html><head><title>Broken Login</title></head>
                    <body>
                        <h1>This Won't Work!</h1>
                        <p>This data URL cannot set cookies for other domains.</p>
                        <script>
                            // This will fail due to browser security restrictions
                            document.cookie = 'session_id=abc123; domain=example.com';
                            alert('Cookie setting failed - security restriction!');
                        </script>
                    </body></html>
                `)}`;
                
                // Generate QR code
                const canvas = document.getElementById('broken-qr');
                const qr = new QRious({
                    element: canvas,
                    value: brokenDataUrl,
                    size: 200,
                    level: 'M',
                    background: '#ffffff',
                    foreground: '#000000'
                });

                showStatus('broken-status', '‚ùå Broken QR code generated. This uses data URLs that cannot set cookies.', 'error');
                showURL('broken-url', brokenDataUrl);
                
            } catch (error) {
                showStatus('broken-status', '‚ùå Error: ' + error.message, 'error');
            }
        }

        function testWorkingURL() {
            const encryptedData = btoa(JSON.stringify(mockSessionData));
            const shareData = {
                type: 'qr_session',
                sessionData: encryptedData,
                targetUrl: mockSessionData.url,
                title: mockSessionData.title,
                timestamp: Date.now()
            };
            
            const encodedData = btoa(JSON.stringify(shareData));
            const mobileLoginUrl = `https://mrx-arafat.github.io/SecureShare/mobile-login.html?data=${encodedData}`;
            
            window.open(mobileLoginUrl, '_blank');
        }

        function testBrokenURL() {
            const encryptedData = btoa(JSON.stringify(mockSessionData));
            const brokenDataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(`
                <!DOCTYPE html>
                <html><head><title>Broken Login</title></head>
                <body style="font-family: Arial; padding: 20px; text-align: center;">
                    <h1 style="color: red;">‚ùå This Won't Work!</h1>
                    <p>This data URL cannot set cookies for other domains due to browser security restrictions.</p>
                    <p><strong>Problem:</strong> Data URLs run in a sandboxed context and cannot access other domains.</p>
                    <button onclick="attemptCookieSet()">Try to Set Cookie (Will Fail)</button>
                    <div id="result" style="margin-top: 20px; padding: 15px; background: #f8d7da; border-radius: 8px;"></div>
                    <script>
                        function attemptCookieSet() {
                            try {
                                document.cookie = 'session_id=abc123; domain=example.com; path=/';
                                document.getElementById('result').innerHTML = '‚ùå Cookie setting failed silently - browser blocked it for security reasons!';
                            } catch (error) {
                                document.getElementById('result').innerHTML = '‚ùå Cookie setting failed with error: ' + error.message;
                            }
                        }
                    </script>
                </body></html>
            `)}`;
            
            window.open(brokenDataUrl, '_blank');
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = 'status ' + type;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        function showURL(elementId, url) {
            const element = document.getElementById(elementId);
            element.textContent = url;
            element.style.display = 'block';
        }

        // Auto-generate working QR on page load
        window.addEventListener('load', function() {
            setTimeout(generateWorkingQR, 500);
        });
    </script>
</body>
</html>
